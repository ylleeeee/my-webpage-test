<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ ë‹¨ì–´ ì•”ê¸° (5ë‹¨ê³„ - ê³ ê¸‰ ê¸°ëŠ¥)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* (v4ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼) */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
            perspective: 1000px;
        }
        .container {
            max-width: 600px;
            width: 90%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: all 0.2s ease-in-out; border: none;
        }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-xs { padding: 0.25rem 0.75rem; font-size: 0.75rem; } /* v5: ì‘ì€ ë²„íŠ¼ */
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not([disabled]) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not([disabled]) { background-color: #4b5563; }
        .btn-success { background-color: #2ecc71; color: white; }
        .btn-success:hover { background-color: #27ae60; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover:not([disabled]) { background-color: #d97706; }
        .btn:disabled { background-color: #cccccc; cursor: not-allowed; }

        /* ì•„ì½”ë””ì–¸(ì ‘ê¸°) ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .accordion-header {
            cursor: pointer;
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-header h2 { font-size: 1.25rem; font-weight: 700; color: #374151; }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion-header.open .accordion-icon { transform: rotate(180deg); }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out; /* 0.3 -> 0.5ì´ˆ */
            background-color: #ffffff;
            padding: 0 1.5rem;
        }
        .accordion-content.open {
            padding: 1.5rem;
            max-height: 1000px; /* v5: ì¶©ë¶„í•œ ë†’ì´ */
            overflow-y: auto;
        }

        /* ë‹¨ì–´ì¥ ëª©ë¡ */
        .quiz-select-cb {
            margin-right: 12px; width: 1.25rem; height: 1.25rem;
            accent-color: #3b82f6; cursor: pointer;
        }
        
        /* v4: ë­í‚¹ ìŠ¤íƒ€ì¼ */
        .ranking-item { display: flex; align-items: center; font-size: 1rem; padding: 0.5rem 0; }
        .ranking-icon { width: 24px; text-align: center; margin-right: 0.75rem; }
        .ranking-name { font-weight: 600; color: #1f2937; }
        .ranking-score { margin-left: auto; color: #4b5563; font-size: 0.9rem; }
        .fa-crown.gold { color: #f59e0b; }
        .fa-crown.silver { color: #9ca3af; }
        .fa-crown.bronze { color: #a16207; }

        /* v4: í•™ìŠµ ê¸°ë¡ ìŠ¤íƒ€ì¼ */
        .history-item {
            background-color: #f8f9fa; border: 1px solid #e9ecef;
            padding: 12px 15px; margin-bottom: 8px; border-radius: 8px;
            font-size: 0.9rem; color: #4b5563;
        }
        .history-item .timestamp { font-weight: 600; color: #1f2937; display: block; margin-bottom: 4px; }
        .history-item .details { font-size: 0.85rem; }
        .history-item .score-badge {
            display: inline-block; background-color: #3b82f6; color: white;
            padding: 2px 8px; border-radius: 12px; font-weight: 600;
            font-size: 0.8rem; margin-left: 8px;
        }
        
        /* --- í€´ì¦ˆ í™”ë©´ --- */
        .quiz-container, .study-complete-container { padding: 20px; display: none; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .quiz-header h2 { font-size: 1.5rem; margin: 0; color: #333; }
        #progress { font-size: 1rem; color: #777; }
        .question-text { font-size: 1.3rem; margin-bottom: 20px; color: #2c3e50; }
        .option-btn {
            display: block; width: 100%; padding: 12px 15px; margin-bottom: 10px;
            background-color: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px;
            font-size: 1rem; cursor: pointer; text-align: left; transition: all 0.2s ease;
        }
        .option-btn:hover:not([disabled]) { background-color: #e2e6ea; border-color: #dae0e5; }
        .option-btn.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .option-btn.wrong { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .rationale {
            margin-top: 15px; padding: 15px; background-color: #eef6fc;
            border-left: 5px solid #2196F3; border-radius: 4px; display: none;
        }
        #next-btn { width: 100%; margin-top: 20px; }

        /* --- ê²°ê³¼ í™”ë©´ --- */
        .result-container { text-align: center; display: none; }
        .result-container h2 { font-size: 2rem; color: #2c3e50; }
        .score-text { font-size: 1.5rem; margin: 20px 0; color: #3498db; }
        #wrong-answers-list {
            margin-top: 30px; text-align: left; border-top: 1px solid #eee; padding-top: 20px;
        }
        #wrong-answers-list h3 { font-size: 1.3rem; color: #ef4444; margin-bottom: 15px; text-align: center; }
        #wrong-answers-list ul { list-style: none; padding: 0; }
        #wrong-answers-list li {
            background-color: #fef2f2; border-left: 4px solid #ef4444; padding: 10px 15px;
            margin-bottom: 8px; border-radius: 4px; font-size: 1rem; color: #be123c;
        }
        #wrong-answers-list li strong { color: #721c24; margin-right: 5px; }

        /* --- v2: í”Œë˜ì‹œì¹´ë“œ --- */
        .flashcard-container { padding: 20px; display: none; }
        .flashcard-scene { width: 100%; height: 300px; perspective: 1000px; cursor: pointer; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px; text-align: center;
        }
        .flashcard-front { background-color: #ffffff; border: 1px solid #e0e0e0; color: #2c3e50; }
        .flashcard-back { background-color: #f8f9fa; color: #333; transform: rotateY(180deg); }
        #flashcard-progress { margin-top: 15px; font-size: 1rem; color: #777; }
        #study-summary-list {
            list-style-type: disc; padding-left: 20px; max-height: 200px; overflow-y: auto;
            background: #f8f9fa; border-radius: 8px; padding: 15px;
        }
        #study-summary-list li { margin-bottom: 8px; }

        /* v5: ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>

    <!-- 1. ì‹œì‘ í™”ë©´ -->
    <div id="start-screen" class="container">
        <div class="p-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">ì˜ì–´ ë‹¨ì–´ ì•”ê¸° (v5)</h1>
            </div>
            
            <div class="mb-6">
                <label for="player-name" class="block text-sm font-medium text-gray-700">í•™ìŠµì ì´ë¦„</label>
                <input type="text" id="player-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë­í‚¹/ê¸°ë¡ìš©)">
            </div>
            
            <div class="border p-6 rounded-lg bg-gray-50 mb-6">
                <h2 class="text-xl font-bold text-gray-700 mb-3">
                    <i class="fas fa-trophy mr-2 text-yellow-500"></i> í•™ìŠµ ë­í‚¹
                </h2>
                <div id="ranking-list" class="space-y-2"></div>
                 <p id="no-ranking-list" class="text-sm text-gray-500 text-center py-2 hidden">ì•„ì§ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="border p-6 rounded-lg bg-gray-50">
                <h2 class="text-xl font-bold text-gray-700 mb-3">ë‹¨ì–´ì¥ ëª©ë¡</h2>
                <p class="text-sm text-gray-500 mb-4">í•™ìŠµí•  ë‹¨ì–´ì¥ì„ ì„ íƒí•˜ì„¸ìš”. (1ê°œ ì´ìƒ)</p>
                <div id="quiz-list" class="space-y-3 mb-4 max-h-48 overflow-y-auto"></div>
                 <p id="no-quiz-list" class="text-sm text-gray-500 text-center py-4 hidden">ì €ì¥ëœ ë‹¨ì–´ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <div class="flex space-x-2">
                    <button id="start-learn-btn" class="btn btn-secondary w-1/2" disabled>
                        <i class="fas fa-book-open mr-2"></i> ë‹¨ì–´ í•™ìŠµ
                    </button>
                    <button id="start-quiz-btn" class="btn btn-primary w-1/2" disabled>
                        <i class="fas fa-pencil-alt mr-2"></i> ë‹¨ì–´ í€´ì¦ˆ
                    </button>
                </div>
                <p id="selection-message" class="text-sm mt-2 h-4 text-center text-blue-600"></p>
            </div>
        </div>
        
        <div class="accordion-container border-t">
            <div id="accordion-header-ondap" class="accordion-header">
                <h2>ì˜¤ë‹µë…¸íŠ¸</h2>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div id="accordion-content-ondap" class="accordion-content">
                <p class="text-sm text-gray-500 mb-4">ì§€ê¸ˆê¹Œì§€ í‹€ë ¸ë˜ ë¬¸ì œë“¤ë§Œ ëª¨ì•„ì„œ ë‹¤ì‹œ í’€ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <button id="start-wrong-quiz-btn" class="btn btn-warning w-full" disabled>
                    <i class="fas fa-redo mr-2"></i> í‹€ë¦° ë¬¸ì œ (0ê°œ) ë‹¤ì‹œ í’€ê¸°
                </button>
                <p id="wrong-quiz-message" class="text-sm mt-2 h-4 text-center"></p>
            </div>
        </div>
        
        <!-- v5: ìƒˆ ë‹¨ì–´ì¥ ë§Œë“¤ê¸° (OCR, ë°œìŒ ê²€ìƒ‰ ì¶”ê°€) -->
        <div class="accordion-container">
            <div id="accordion-header-new-quiz" class="accordion-header">
                <h2>ìƒˆ ë‹¨ì–´ì¥ ì§ì ‘ ë§Œë“¤ê¸°</h2>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div id="accordion-content-new-quiz" class="accordion-content">
                
                <!-- v5: OCR ê¸°ëŠ¥ -->
                <div class="border p-4 rounded-lg bg-blue-50 mb-6">
                    <h3 class="text-md font-bold text-gray-700 mb-2">ì´ë¯¸ì§€ì—ì„œ ë‹¨ì–´ ê°€ì ¸ì˜¤ê¸° (AI)</h3>
                    <p class="text-sm text-gray-600 mb-3">ë‹¨ì–´ì™€ ì˜ë¯¸ê°€ í¬í•¨ëœ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                    <input type="file" id="ocr-image-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200" accept="image/*">
                    <button id="ocr-extract-btn" class="btn btn-primary w-full mt-3">
                        <i class="fas fa-magic mr-2"></i> í…ìŠ¤íŠ¸ ì¶”ì¶œ
                    </button>
                    <p id="ocr-message" class="text-sm mt-2 h-4"></p>
                </div>
                
                <!-- v5: ë‹¨ì–´ì¥ ì´ë¦„ -->
                <div class="mb-4">
                    <label for="new-quiz-name" class="block text-sm font-medium text-gray-700">ë‹¨ì–´ì¥ ì´ë¦„</label>
                    <input type="text" id="new-quiz-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="ì˜ˆ: í† ìµ í•„ìˆ˜ ë‹¨ì–´ 1">
                </div>

                <!-- v5: ì¶”ê°€ëœ ë‹¨ì–´ ëª©ë¡ -->
                <div class="p-4 border rounded-lg bg-white mb-4">
                    <h3 class="text-md font-medium text-gray-700 mb-2">ì¶”ê°€ëœ ë‹¨ì–´ ëª©ë¡ (<span id="temp-word-count">0</span>/4ê°œ ì´ìƒ)</h3>
                    <div id="temp-word-list" class="max-h-24 overflow-y-auto text-sm text-gray-600 space-y-1">
                        <p class="text-gray-400">ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”...</p>
                    </div>
                </div>

                <!-- v5: ìˆ˜ë™ ì…ë ¥ í¼ -->
                <div id="add-word-form" class="space-y-3">
                    <div class="relative">
                        <input type="text" id="new-word" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="ì˜ì–´ ë‹¨ì–´ (ì˜ˆ: apple)">
                    </div>
                    <input type="text" id="new-meaning" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="í•œêµ­ì–´ ì˜ë¯¸ (ì˜ˆ: ì‚¬ê³¼)">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="new-phonetic" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="ë°œìŒ ê¸°í˜¸ (ì„ íƒ)">
                        <button id="fetch-phonetic-btn" class="btn btn-xs btn-secondary">
                            <i class="fas fa-search mr-1"></i> ìë™ ê²€ìƒ‰
                        </button>
                        <div id="phonetic-loader" class="loader"></div>
                    </div>
                    <button id="add-word-btn" class="btn btn-secondary w-full"><i class="fas fa-plus mr-2"></i>ë‹¨ì–´ ì¶”ê°€</button>
                </div>

                <button id="save-new-quiz-btn" class="btn btn-primary w-full mt-4"><i class="fas fa-save mr-2"></i>ì´ ë‹¨ì–´ì¥ ì €ì¥í•˜ê¸°</button>
                <p id="manual-add-message" class="text-sm mt-2 h-4"></p>
            </div>
        </div>
        
        <div class="accordion-container">
            <div id="accordion-header-history" class="accordion-header">
                <h2>ì „ì²´ í•™ìŠµ ê¸°ë¡</h2>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
            <div id="accordion-content-history" class="accordion-content">
                <button id="clear-history-btn" class="btn btn-sm btn-danger w-full mb-4">
                    <i class="fas fa-trash-alt mr-2"></i> ëª¨ë“  ê¸°ë¡ ì§€ìš°ê¸°
                </button>
                 <div id="history-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
                 <p id="no-history-list" class="text-sm text-gray-500 text-center py-4 hidden">í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

    </div>

    <!-- v2: ë‹¨ì–´ í•™ìŠµ (í”Œë˜ì‹œì¹´ë“œ) í™”ë©´ -->
    <div class="container flashcard-container" id="flashcard-container">
        <div class="flex justify-between items-center mb-4">
            <h2 id="flashcard-title" class="text-xl font-bold">ë‹¨ì–´ í•™ìŠµ</h2>
            <button id="exit-study-btn" class="btn btn-secondary btn-sm">í•™ìŠµ ì¢…ë£Œ</button>
        </div>
        <div class="flashcard-scene" id="flashcard-scene">
            <div class="flashcard" id="flashcard">
                <div class="flashcard-face flashcard-front" id="flashcard-front"></div>
                <div class="flashcard-face flashcard-back" id="flashcard-back"></div>
            </div>
        </div>
        <div id="flashcard-progress" class="text-center"></div>
        <div class="flex justify-between mt-6">
            <button id="prev-card-btn" class="btn btn-secondary">ì´ì „ ì¹´ë“œ</button>
            <button id="next-card-btn" class="btn btn-primary">ë‹¤ìŒ ì¹´ë“œ</button>
        </div>
    </div>

    <!-- v2: í•™ìŠµ ì™„ë£Œ í™”ë©´ -->
    <div class="container study-complete-container" id="study-complete-container">
        <h2 class="text-2xl font-bold text-center mb-4">í•™ìŠµ ì™„ë£Œ!</h2>
        <p class="text-gray-700 mb-4">ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ëª¨ë‘ í•™ìŠµí–ˆìŠµë‹ˆë‹¤:</p>
        <ul id="study-summary-list" class="mb-6"></ul>
        <p class="text-center text-lg font-medium text-gray-800 mb-6">
            ë‹¨ì–´ í€´ì¦ˆì— ë„ì „í•´ ë³¼ê¹Œìš”?
        </p>
        <div class="space-y-3">
            <button id="start-quiz-from-summary-btn" class="btn btn-primary w-full">í€´ì¦ˆ ë„ì „!</button>
            <button id="main-from-summary-btn" class="btn btn-secondary w-full">ë©”ì¸ìœ¼ë¡œ</button>
        </div>
    </div>


    <!-- 2. í€´ì¦ˆ í™”ë©´ -->
    <div class="container quiz-container" id="quiz-container">
        <div class="quiz-header">
            <h2 id="quiz-title">ê¸°ë³¸ í€´ì¦ˆ</h2>
            <span id="progress"></span>
        </div>
        <div id="quiz-content">
            <div class="question-text" id="question"></div>
            <div id="options"></div>
            <div class="rationale" id="rationale"></div>
            <button id="next-btn" class="btn btn-primary" disabled>ë‹¤ìŒ</button>
        </div>
        <div class="result-container" id="result">
            <h2>í€´ì¦ˆ ì™„ë£Œ!</h2>
            <div class="score-text" id="score-display"></div>
            <div id="wrong-answers-list"></div>
            <div class="mt-8">
                <button id="retry-btn" class="btn btn-success">ë‹¤ì‹œ í’€ê¸°</button>
                <button id="back-to-main-btn" class="btn btn-secondary">ë©”ì¸ìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. ê¸°ë³¸ í€´ì¦ˆ ë°ì´í„° (20ë¬¸ì œ) ---
    // v5: ë°œìŒ ê¸°í˜¸(phonetic) ì¶”ê°€
    const sampleQuizData = [
        { word: "restroom", meaning: "í™”ì¥ì‹¤", phonetic: "/ËˆrÉ›struËm/", question: "ë‹¤ìŒ ë‹¨ì–´ 'restroom'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ê³µê³µì¥ì†Œ", options: ["ìˆ™ì œ", "í™”ì¥ì‹¤", "ë¹„í–‰ê¸°", "êµ­ê°€"], correct: 1, rationale: "'restroom'ì€(ëŠ”) 'í™”ì¥ì‹¤'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "difficult", meaning: "ì–´ë ¤ìš´", phonetic: "/ËˆdÉªfÉªkÉ™lt/", question: "ë‹¤ìŒ ë‹¨ì–´ 'difficult'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "easyì˜ ë°˜ëŒ€", options: ["ì–´ë ¤ìš´", "ê±°ì¸, ê±°ëŒ€í•œ", "ì†Œí’", "ìˆ™ì œ"], correct: 0, rationale: "'difficult'ì€(ëŠ”) 'ì–´ë ¤ìš´'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "hungry", meaning: "ë°°ê³ í”ˆ", phonetic: "/ËˆhÊŒÅ‹É¡ri/", question: "ë‹¤ìŒ ë‹¨ì–´ 'hungry'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì‹ìš•ì„ ëŠë¼ëŠ” ìƒíƒœ", options: ["ë°°ê³ í”ˆ", "ì‚°", "êµ­ê°€", "í™”ì¥ì‹¤"], correct: 0, rationale: "'hungry'ì€(ëŠ”) 'ë°°ê³ í”ˆ'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "beautiful", meaning: "ì•„ë¦„ë‹¤ìš´", phonetic: "/ËˆbjuËtÉªfl/", question: "ë‹¤ìŒ ë‹¨ì–´ 'beautiful'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì‹œê°ì /ê°ê°ì ", options: ["ì–´ì œ", "ì•„ë¦„ë‹¤ìš´", "ì–´ë ¤ìš´", "ì˜·"], correct: 1, rationale: "'beautiful'ì€(ëŠ”) 'ì•„ë¦„ë‹¤ìš´'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "remember", meaning: "ê¸°ì–µí•˜ë‹¤", phonetic: "/rÉªËˆmÉ›mbÉ™r/", question: "ë‹¤ìŒ ë‹¨ì–´ 'remember'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ê³¼ê±°ì˜ ì¼ì„ ë– ì˜¬ë¦¼", options: ["ë¹„í–‰ê¸°", "ê¸°ì–µí•˜ë‹¤", "ë°•ë¬¼ê´€", "ë°°ê³ í”ˆ"], correct: 1, rationale: "'remember'ì€(ëŠ”) 'ê¸°ì–µí•˜ë‹¤'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "museum", meaning: "ë°•ë¬¼ê´€", phonetic: "/mjuËËˆziËÉ™m/", question: "ë‹¤ìŒ ë‹¨ì–´ 'museum'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ìœ ë¬¼, ì˜ˆìˆ í’ˆ ì „ì‹œ", options: ["ê¸°ì–µí•˜ë‹¤", "ë°•ë¬¼ê´€", "í˜¸ê¸°ì‹¬ì´ ë§ì€", "ì†Œí’"], correct: 1, rationale: "'museum'ì€(ëŠ”) 'ë°•ë¬¼ê´€'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "curious", meaning: "í˜¸ê¸°ì‹¬ì´ ë§ì€", phonetic: "/ËˆkjÊŠÉ™riÉ™s/", question: "ë‹¤ìŒ ë‹¨ì–´ 'curious'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì•Œê³  ì‹¶ì–´ í•˜ëŠ” ë§ˆìŒ", options: ["í˜¸ê¸°ì‹¬ì´ ë§ì€", "êµ­ê°€", "ê°ì", "ìœ„í—˜"], correct: 0, rationale: "'curious'ì€(ëŠ”) 'í˜¸ê¸°ì‹¬ì´ ë§ì€'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "yesterday", meaning: "ì–´ì œ", phonetic: "/ËˆjÉ›stÉ™rdeÉª/", question: "ë‹¤ìŒ ë‹¨ì–´ 'yesterday'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì˜¤ëŠ˜ì˜ ë°”ë¡œ ì „ë‚ ", options: ["ìœ„í—˜", "ì‚°", "ìˆ™ì œ", "ì–´ì œ"], correct: 3, rationale: "'yesterday'ì€(ëŠ”) 'ì–´ì œ'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "gesture", meaning: "ëª¸ì§“, ì œìŠ¤ì²˜", phonetic: "/ËˆdÊ’É›stÊƒÉ™r/", question: "ë‹¤ìŒ ë‹¨ì–´ 'gesture'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì˜ì‚¬ ì „ë‹¬ ìˆ˜ë‹¨", options: ["ëª¸ì§“, ì œìŠ¤ì²˜", "ê¸°ì–µí•˜ë‹¤", "ìˆ™ì œ", "ë°°ê³ í”ˆ"], correct: 0, rationale: "'gesture'ì€(ëŠ”) 'ëª¸ì§“, ì œìŠ¤ì²˜'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "condition", meaning: "ìƒíƒœ, ì¡°ê±´", phonetic: "/kÉ™nËˆdÉªÊƒn/", question: "ë‹¤ìŒ ë‹¨ì–´ 'condition'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì‚¬ë¬¼/ì‚¬ëŒì˜ í˜„í™©", options: ["ì•„ë¦„ë‹¤ìš´", "ìƒíƒœ, ì¡°ê±´", "ì—­ì‚¬", "ì–´ì œ"], correct: 1, rationale: "'condition'ì€(ëŠ”) 'ìƒíƒœ, ì¡°ê±´'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "danger", meaning: "ìœ„í—˜", phonetic: "/ËˆdeÉªndÊ’É™r/", question: "ë‹¤ìŒ ë‹¨ì–´ 'danger'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì•ˆì „í•˜ì§€ ì•Šì€ ìƒíƒœ", options: ["ìœ„í—˜", "ì˜·", "í™”ì¥ì‹¤", "ìˆ™ì œ"], correct: 0, rationale: "'danger'ì€(ëŠ”) 'ìœ„í—˜'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "airplane", meaning: "ë¹„í–‰ê¸°", phonetic: "/ËˆÉ›É™rpleÉªn/", question: "ë‹¤ìŒ ë‹¨ì–´ 'airplane'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "í•˜ëŠ˜ì„ ë‚˜ëŠ” êµí†µìˆ˜ë‹¨", options: ["êµ­ê°€", "ì˜·", "ë¹„í–‰ê¸°", "ì—­ì‚¬"], correct: 2, rationale: "'airplane'ì€(ëŠ”) 'ë¹„í–‰ê¸°'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "history", meaning: "ì—­ì‚¬", phonetic: "/ËˆhÉªstÉ™ri/", question: "ë‹¤ìŒ ë‹¨ì–´ 'history'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ê³¼ê±°ì˜ ì‚¬ì‹¤, ê¸°ë¡", options: ["ê°ì", "ì—­ì‚¬", "ì–´ë ¤ìš´", "ë°•ë¬¼ê´€"], correct: 1, rationale: "'history'ì€(ëŠ”) 'ì—­ì‚¬'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "clothes", meaning: "ì˜·", phonetic: "/kloÊŠÃ°z/", question: "ë‹¤ìŒ ë‹¨ì–´ 'clothes'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ëª¸ì— ì…ëŠ” ê²ƒ", options: ["ì˜·", "ì†Œí’", "êµ­ê°€", "ìƒíƒœ, ì¡°ê±´"], correct: 0, rationale: "'clothes'ì€(ëŠ”) 'ì˜·'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "giant", meaning: "ê±°ì¸, ê±°ëŒ€í•œ", phonetic: "/ËˆdÊ’aÉªÉ™nt/", question: "ë‹¤ìŒ ë‹¨ì–´ 'giant'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ë§¤ìš° í° ì‚¬ëŒ/ì‚¬ë¬¼", options: ["ê±°ì¸, ê±°ëŒ€í•œ", "ì˜·", "ë¹„í–‰ê¸°", "ê°ì"], correct: 0, rationale: "'giant'ì€(ëŠ”) 'ê±°ì¸, ê±°ëŒ€í•œ'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "nation", meaning: "êµ­ê°€", phonetic: "/ËˆneÉªÊƒn/", question: "ë‹¤ìŒ ë‹¨ì–´ 'nation'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì˜í† ì™€ êµ­ë¯¼ì„ ê°€ì§„ ë‚˜ë¼", options: ["êµ­ê°€", "ê¸°ì–µí•˜ë‹¤", "í™”ì¥ì‹¤", "ì‚°"], correct: 0, rationale: "'nation'ì€(ëŠ”) 'êµ­ê°€'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "mountain", meaning: "ì‚°", phonetic: "/ËˆmaÊŠntn/", question: "ë‹¤ìŒ ë‹¨ì–´ 'mountain'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ë†’ì´ ì†Ÿì€ ì§€í˜•", options: ["ìˆ™ì œ", "ì‚°", "ì—­ì‚¬", "ì•„ë¦„ë‹¤ìš´"], correct: 1, rationale: "'mountain'ì€(ëŠ”) 'ì‚°'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "picnic", meaning: "ì†Œí’", phonetic: "/ËˆpÉªknÉªk/", question: "ë‹¤ìŒ ë‹¨ì–´ 'picnic'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ì•¼ì™¸ë¡œ ë†€ëŸ¬ ê°€ëŠ” ê²ƒ", options: ["í˜¸ê¸°ì‹¬ì´ ë§ì€", "ì†Œí’", "ì–´ì œ", "ê¸°ì–µí•˜ë‹¤"], correct: 1, rationale: "'picnic'ì€(ëŠ”) 'ì†Œí’'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "potato", meaning: "ê°ì", phonetic: "/pÉ™ËˆteÉªtoÊŠ/", question: "ë‹¤ìŒ ë‹¨ì–´ 'potato'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "ë•…ì† ë©ì´ì¤„ê¸° ì±„ì†Œ", options: ["ëª¸ì§“, ì œìŠ¤ì²˜", "ê°ì", "ìœ„í—˜", "ì–´ë ¤ìš´"], correct: 1, rationale: "'potato'ì€(ëŠ”) 'ê°ì'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." },
        { word: "homework", meaning: "ìˆ™ì œ", phonetic: "/ËˆhoÊŠmwÉœËrk/", question: "ë‹¤ìŒ ë‹¨ì–´ 'homework'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", hint: "í•™ìƒì´ ì§‘ì—ì„œ í•˜ëŠ” ê³¼ì œ", options: ["ìˆ™ì œ", "ìƒíƒœ, ì¡°ê±´", "ì–´ì œ", "ì‚°"], correct: 0, rationale: "'homework'ì€(ëŠ”) 'ìˆ™ì œ'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤." }
    ];

    // --- 2. DOM ìš”ì†Œ ---
    const startScreen = document.getElementById('start-screen');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    
    // í€´ì¦ˆ í™”ë©´
    const quizContainer = document.getElementById('quiz-container');
    const quizTitleEl = document.getElementById('quiz-title');
    const progressEl = document.getElementById('progress');
    const quizContentEl = document.getElementById('quiz-content');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const rationaleEl = document.getElementById('rationale');
    const nextBtn = document.getElementById('next-btn');
    
    // ê²°ê³¼ í™”ë©´
    const resultEl = document.getElementById('result');
    const scoreDisplayEl = document.getElementById('score-display');
    const wrongAnswersListDiv = document.getElementById('wrong-answers-list');
    const retryBtn = document.getElementById('retry-btn');
    const backToMainBtn = document.getElementById('back-to-main-btn');

    // v2: í”Œë˜ì‹œì¹´ë“œ DOM ìš”ì†Œ
    const startLearnBtn = document.getElementById('start-learn-btn');
    const flashcardContainer = document.getElementById('flashcard-container');
    const flashcard = document.getElementById('flashcard');
    const flashcardTitle = document.getElementById('flashcard-title');
    const flashcardFront = document.getElementById('flashcard-front');
    const flashcardBack = document.getElementById('flashcard-back');
    const flashcardProgress = document.getElementById('flashcard-progress');
    const prevCardBtn = document.getElementById('prev-card-btn');
    const nextCardBtn = document.getElementById('next-card-btn');
    const exitStudyBtn = document.getElementById('exit-study-btn');
    const studyCompleteContainer = document.getElementById('study-complete-container');
    const studySummaryList = document.getElementById('study-summary-list');
    const startQuizFromSummaryBtn = document.getElementById('start-quiz-from-summary-btn');
    const mainFromSummaryBtn = document.getElementById('main-from-summary-btn');

    // v3: ë‹¨ì–´ì¥ ì €ì¥ DOM ìš”ì†Œ
    const quizList = document.getElementById('quiz-list');
    const noQuizList = document.getElementById('no-quiz-list');
    const selectionMessage = document.getElementById('selection-message');
    const accordionHeaderNewQuiz = document.getElementById('accordion-header-new-quiz');
    const accordionContentNewQuiz = document.getElementById('accordion-content-new-quiz');
    const newQuizNameInput = document.getElementById('new-quiz-name');
    const tempWordListDiv = document.getElementById('temp-word-list');
    const tempWordCountSpan = document.getElementById('temp-word-count');
    const newWordInput = document.getElementById('new-word');
    const newMeaningInput = document.getElementById('new-meaning');
    // const newHintInput = document.getElementById('new-hint'); // v5: phoneticìœ¼ë¡œ ëŒ€ì²´
    const addWordBtn = document.getElementById('add-word-btn');
    const saveNewQuizBtn = document.getElementById('save-new-quiz-btn');
    const manualAddMessage = document.getElementById('manual-add-message');
    
    // v4: ë­í‚¹, ê¸°ë¡, ì˜¤ë‹µë…¸íŠ¸ DOM ìš”ì†Œ
    const playerNameInput = document.getElementById('player-name');
    const rankingList = document.getElementById('ranking-list');
    const noRankingList = document.getElementById('no-ranking-list');
    
    const accordionHeaderOndap = document.getElementById('accordion-header-ondap');
    const accordionContentOndap = document.getElementById('accordion-content-ondap');
    const startWrongQuizBtn = document.getElementById('start-wrong-quiz-btn');
    const wrongQuizMessage = document.getElementById('wrong-quiz-message');
    
    const accordionHeaderHistory = document.getElementById('accordion-header-history');
    const accordionContentHistory = document.getElementById('accordion-content-history');
    const historyList = document.getElementById('history-list');
    const noHistoryList = document.getElementById('no-history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    
    // v5: OCR, ë°œìŒ ê²€ìƒ‰ DOM ìš”ì†Œ
    const ocrImageInput = document.getElementById('ocr-image-input');
    const ocrExtractBtn = document.getElementById('ocr-extract-btn');
    const ocrMessage = document.getElementById('ocr-message');
    const newPhoneticInput = document.getElementById('new-phonetic');
    const fetchPhoneticBtn = document.getElementById('fetch-phonetic-btn');
    const phoneticLoader = document.getElementById('phonetic-loader');


    // --- 3. í€´ì¦ˆ/í•™ìŠµ ìƒíƒœ ë³€ìˆ˜ ---
    let activeQuizData = []; 
    let currentQuestionIndex = 0;
    let score = 0;
    let wrongAnswers = []; 

    let activeStudyData = []; 
    let currentCardIndex = 0;
    let autoFlipTimer; 

    // v3: ë‹¨ì–´ì¥ ì €ì¥ ë³€ìˆ˜
    let savedWordLists = [];
    const STORAGE_KEY = 'englishQuizLists_v5'; // v5ë¡œ í‚¤ ë³€ê²½
    let tempWords = []; 

    // v4: ë­í‚¹, ê¸°ë¡, ì˜¤ë‹µë…¸íŠ¸ ë³€ìˆ˜
    let currentPlayerName = '';
    const PLAYER_KEY = 'englishQuizPlayer_v5';
    let rankings = []; 
    const RANKING_KEY = 'englishQuizRankings_v5';
    let wrongAnswerBank = []; 
    const WRONG_ANSWERS_KEY = 'englishQuizWrongAnswers_v5';
    let quizHistory = []; 
    const HISTORY_KEY = 'englishQuizHistory_v5';

    // --- 4. í€´ì¦ˆ í•¨ìˆ˜ (v1, v2) ---
    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function startQuiz(quizData, title = "ë‹¨ì–´ í€´ì¦ˆ") {
        if (quizData.length === 0) {
             selectionMessage.textContent = 'í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë‹¨ì–´ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.';
             selectionMessage.className = 'text-sm mt-2 h-4 text-center text-red-500';
             return;
        }
        activeQuizData = quizData.map(q => ({...q, answered: false, selected: -1})); 
        shuffleArray(activeQuizData); 
        
        currentQuestionIndex = 0;
        score = 0;
        wrongAnswers = [];
        
        quizTitleEl.textContent = title; 
        startScreen.classList.add('hidden');
        flashcardContainer.style.display = 'none'; 
        studyCompleteContainer.style.display = 'none'; 
        quizContainer.style.display = 'block';
        quizContentEl.style.display = 'block';
        resultEl.style.display = 'none';
        wrongAnswersListDiv.innerHTML = '';

        loadQuestion();
    }

    function loadQuestion() {
        resetState();
        const currentQuestion = activeQuizData[currentQuestionIndex];
        
        progressEl.textContent = `ë¬¸ì œ ${currentQuestionIndex + 1} / ${activeQuizData.length}`;
        questionEl.textContent = currentQuestion.question;
        
        currentQuestion.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.classList.add('option-btn');
            button.textContent = option;
            button.dataset.index = index;
            button.addEventListener('click', selectAnswer);
            optionsEl.appendChild(button);
        });
    }

    function resetState() {
        optionsEl.innerHTML = '';
        rationaleEl.style.display = 'none';
        rationaleEl.textContent = '';
        nextBtn.disabled = true;
    }

    function selectAnswer(e) {
        const selectedBtn = e.target;
        const selectedIndex = parseInt(selectedBtn.dataset.index);
        const currentQuestion = activeQuizData[currentQuestionIndex];
        const correctIndex = currentQuestion.correct;
        
        if (currentQuestion.answered) return; 
        currentQuestion.answered = true;
        currentQuestion.selected = selectedIndex;
        
        if (selectedIndex === correctIndex) {
            selectedBtn.classList.add('correct');
            score++;
            removeWrongAnswer(currentQuestion); 
        } else {
            selectedBtn.classList.add('wrong');
            wrongAnswers.push(currentQuestion); 
            addWrongAnswer(currentQuestion); 
        }
        
        Array.from(optionsEl.children).forEach(btn => {
            if (parseInt(btn.dataset.index) === correctIndex) {
                btn.classList.add('correct');
            }
            btn.disabled = true;
        });

        if (currentQuestion.rationale) {
            rationaleEl.textContent = currentQuestion.rationale;
            rationaleEl.style.display = 'block';
        }
        
        nextBtn.disabled = false;
    }

    function showResults() {
        quizContentEl.style.display = 'none';
        resultEl.style.display = 'block';
        scoreDisplayEl.textContent = `ì´ ${activeQuizData.length}ë¬¸ì œ ì¤‘ ${score}ê°œë¥¼ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤!`;

        const total = activeQuizData.length;
        if (total > 0) {
            const historyEntry = {
                timestamp: new Date().getTime(),
                quizName: quizTitleEl.textContent,
                total: total,
                correct: score,
                wrong: total - score
            };
            addHistoryEntry(historyEntry);
            updateRankings(currentPlayerName, score);
        }

        wrongAnswersListDiv.innerHTML = ''; 
        if (wrongAnswers.length > 0) {
            const h3 = document.createElement('h3');
            h3.textContent = 'í‹€ë¦° ë¬¸ì œ ëª©ë¡';
            wrongAnswersListDiv.appendChild(h3);

            const ul = document.createElement('ul');
            wrongAnswers.forEach(q => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${q.word}</strong>: ${q.meaning}`;
                ul.appendChild(li);
            });
            wrongAnswersListDiv.appendChild(ul);
        } else {
            const p = document.createElement('p');
            p.textContent = 'ëª¨ë“  ë¬¸ì œë¥¼ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤! ğŸ‰';
            p.className = 'text-center text-green-600 font-bold mt-4';
            wrongAnswersListDiv.appendChild(p);
        }
    }

    function handleNextButton() {
        currentQuestionIndex++;
        if (currentQuestionIndex < activeQuizData.length) {
            loadQuestion();
        } else {
            showResults();
        }
    }

    // --- v2: í”Œë˜ì‹œì¹´ë“œ í•¨ìˆ˜ ---
    function startStudy(studyData, title = "ë‹¨ì–´ í•™ìŠµ") {
         if (studyData.length === 0) {
             selectionMessage.textContent = 'í•™ìŠµì„ ì‹œì‘í•˜ë ¤ë©´ ë‹¨ì–´ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.';
             selectionMessage.className = 'text-sm mt-2 h-4 text-center text-red-500';
             return;
        }
        activeStudyData = studyData.map(q => ({...q})); 
        shuffleArray(activeStudyData);
        currentCardIndex = 0;

        flashcardTitle.textContent = title; 
        startScreen.classList.add('hidden');
        flashcardContainer.style.display = 'block';
        studyCompleteContainer.style.display = 'none';

        loadCard(currentCardIndex);
    }

    function loadCard(index) {
        if (autoFlipTimer) clearTimeout(autoFlipTimer);
        const card = activeStudyData[index];
        
        // v5: ë°œìŒ ê¸°í˜¸ í‘œì‹œ
        flashcardFront.innerHTML = `
            <div class="text-4xl md:text-5xl font-bold">${card.word}</div>
            <div class="text-xl md:text-2xl text-gray-500 mt-3">
                ${card.phonetic ? card.phonetic : '&nbsp;'} 
            </div>
            <div class="text-lg text-gray-400 mt-4">(í´ë¦­í•˜ì—¬ ë’¤ì§‘ê¸°)</div>
        `;
        flashcardBack.innerHTML = `
            <div class="text-3xl md:text-4xl font-bold">${card.meaning}</div>
            <div class="text-lg text-gray-600 mt-3">${card.hint || ''}</div>
        `;
        
        flashcard.classList.remove('is-flipped'); 
        flashcardProgress.textContent = `ì¹´ë“œ ${index + 1} / ${activeStudyData.length}`;
        prevCardBtn.disabled = (index === 0);
        
        autoFlipTimer = setTimeout(() => {
            flipCard();
        }, 3000);
    }

    function flipCard() {
        if (autoFlipTimer) clearTimeout(autoFlipTimer);
        flashcard.classList.toggle('is-flipped');
    }

    function showNextCard() {
        if (currentCardIndex < activeStudyData.length - 1) {
            currentCardIndex++;
            loadCard(currentCardIndex);
        } else {
            showStudySummary();
        }
    }

    function showPrevCard() {
        if (currentCardIndex > 0) {
            currentCardIndex--;
            loadCard(currentCardIndex);
        }
    }

    function showStudySummary() {
        flashcardContainer.style.display = 'none';
        studyCompleteContainer.style.display = 'block';
        
        studySummaryList.innerHTML = '';
        activeStudyData.forEach(card => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${card.word}</strong>: ${card.meaning}`;
            studySummaryList.appendChild(li);
        });
    }

    function showMainScreen() {
        quizContainer.style.display = 'none';
        resultEl.style.display = 'none';
        flashcardContainer.style.display = 'none';
        studyCompleteContainer.style.display = 'none';
        startScreen.classList.remove('hidden');
        
        renderWordList();
        renderRankings();
        renderWrongQuizButton();
        renderHistory();
        
        startLearnBtn.disabled = true;
        startQuizBtn.disabled = true;
        selectionMessage.textContent = '';
    }


    // --- v3: ë‹¨ì–´ì¥ ì €ì¥ í•¨ìˆ˜ ---

    function loadWordLists() {
        const stored = localStorage.getItem(STORAGE_KEY);
        savedWordLists = stored ? JSON.parse(stored) : [];
    }

    function saveWordLists() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedWordLists));
    }

    function renderWordList() {
        quizList.innerHTML = '';
        
        const sampleQuizItem = document.createElement('div');
        sampleQuizItem.className = 'flex items-center p-3 bg-white border rounded-lg';
        sampleQuizItem.innerHTML = `
            <input type="checkbox" class="quiz-select-cb" id="quiz-cb-sample" data-index="-1">
            <label for="quiz-cb-sample" class="font-medium text-gray-700 flex-grow cursor-pointer">
                ê¸°ë³¸ í€´ì¦ˆ (${sampleQuizData.length}ë¬¸ì œ)
            </label>
        `;
        quizList.appendChild(sampleQuizItem);

        if (savedWordLists.length === 0) {
            noQuizList.classList.remove('hidden');
        } else {
            noQuizList.classList.add('hidden');
            savedWordLists.forEach((quiz, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center p-3 bg-white border rounded-lg';
                listItem.innerHTML = `
                    <input type="checkbox" class="quiz-select-cb" id="quiz-cb-${index}" data-index="${index}">
                    <label for="quiz-cb-${index}" class="font-medium text-gray-700 flex-grow cursor-pointer">${quiz.name} (${quiz.questions.length}ë¬¸ì œ)</label>
                    <button class="btn btn-sm btn-danger delete-quiz-btn" data-index="${index}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                quizList.appendChild(listItem);
            });
        }
    }

    function renderTempWordList() {
        tempWordListDiv.innerHTML = '';
        if (tempWords.length === 0) {
            tempWordListDiv.innerHTML = '<p class="text-gray-400">ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”...</p>';
        }
        tempWords.forEach(w => {
            const div = document.createElement('div');
            div.className = "flex justify-between items-center";
            div.innerHTML = `
                <span><strong>${w.word}</strong>: ${w.meaning} ${w.phonetic ? `(${w.phonetic})` : ''}</span>
                <button class="delete-temp-word-btn text-red-500 hover:text-red-700" data-word="${w.word}">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            tempWordListDiv.appendChild(div);
        });
        tempWordCountSpan.textContent = tempWords.length;
    }

    function generateQuizFromWords(words) {
        const questions = [];
        const allMeanings = words.map(w => w.meaning);

        for (const wordData of words) {
            // v5: phonetic ì¶”ê°€
            const { word, meaning, hint, phonetic } = wordData;
            
            const question = `ë‹¤ìŒ ë‹¨ì–´ '${word}'ì˜ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?`;
            const rationale = `'${word}' (${phonetic || 'N/A'})ì€(ëŠ”) '${meaning}'ì„(ë¥¼) ì˜ë¯¸í•©ë‹ˆë‹¤.`;
            
            let distractors = allMeanings.filter(m => m !== meaning);
            shuffleArray(distractors);
            distractors = distractors.slice(0, 3);

            const baseDistractors = ["ì»´í“¨í„°", "ì—°í•„", "í•™êµ", "ë¬¼ë³‘", "ì‚¬ë‘", "ì‹œê°„", "í•˜ëŠ˜"];
            let distractorIdx = 0;
            while (distractors.length < 3) {
                const newDistractor = baseDistractors[distractorIdx % baseDistractors.length];
                distractorIdx++;
                if (newDistractor !== meaning && !distractors.includes(newDistractor)) {
                    distractors.push(newDistractor);
                }
            }
            
            let options = [...distractors, meaning];
            shuffleArray(options); 
            
            const correctIndex = options.indexOf(meaning);
            
            questions.push({
                word, meaning, hint: hint || '', phonetic: phonetic || null, // v5: phonetic ì €ì¥
                question, options, correct: correctIndex, rationale
            });
        }
        return questions;
    }

    function getCombinedQuestions() {
        const checkedBoxes = quizList.querySelectorAll('.quiz-select-cb:checked');
        let combinedQuestions = [];
        let combinedNames = [];

        checkedBoxes.forEach(box => {
            const index = parseInt(box.dataset.index, 10);
            if (index === -1) { 
                combinedQuestions.push(...sampleQuizData);
                combinedNames.push('ê¸°ë³¸ í€´ì¦ˆ');
            } else {
                const quiz = savedWordLists[index];
                combinedQuestions.push(...quiz.questions);
                combinedNames.push(quiz.name);
            }
        });
        
        return { questions: combinedQuestions, title: combinedNames.join(' + ') || 'ë‹¨ì–´' };
    }
    
    // --- v4: ë­í‚¹, ê¸°ë¡, ì˜¤ë‹µë…¸íŠ¸ í•¨ìˆ˜ ---

    function loadPlayerName() {
        currentPlayerName = localStorage.getItem(PLAYER_KEY) || '';
        playerNameInput.value = currentPlayerName;
    }

    function savePlayerName(name) {
        currentPlayerName = name;
        localStorage.setItem(PLAYER_KEY, name);
    }
    
    function loadRankings() {
        const stored = localStorage.getItem(RANKING_KEY);
        rankings = stored ? JSON.parse(stored) : []; 
    }

    function saveRankings() {
        rankings.sort((a, b) => b.totalScore - a.totalScore); 
        rankings = rankings.slice(0, 3); 
        localStorage.setItem(RANKING_KEY, JSON.stringify(rankings));
    }

    function renderRankings() {
        rankingList.innerHTML = '';
        if (rankings.length === 0) {
            noRankingList.classList.remove('hidden');
        } else {
            noRankingList.classList.add('hidden');
            const icons = [
                '<i class="fas fa-crown gold"></i>', 
                '<i class="fas fa-crown silver"></i>', 
                '<i class="fas fa-crown bronze"></i>'
            ];
            rankings.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.innerHTML = `
                    <span class="ranking-icon">${icons[index]}</span>
                    <span class="ranking-name">${entry.name}</span>
                    <span class="ranking-score">${entry.totalScore}ì  (ëˆ„ì )</span>
                `;
                rankingList.appendChild(div);
            });
        }
    }
    
    function updateRankings(name, score) {
        if (!name || score === 0) return; 
        
        const existingIndex = rankings.findIndex(r => r.name === name);
        if (existingIndex > -1) {
            rankings[existingIndex].totalScore += score;
        } else {
            rankings.push({ name: name, totalScore: score });
        }
        saveRankings();
        renderRankings();
    }
    
    function loadWrongAnswerBank() {
        const stored = localStorage.getItem(WRONG_ANSWERS_KEY);
        wrongAnswerBank = stored ? JSON.parse(stored) : []; 
    }
    
    function saveWrongAnswerBank() {
        localStorage.setItem(WRONG_ANSWERS_KEY, JSON.stringify(wrongAnswerBank));
    }
    
    function addWrongAnswer(question) {
        if (!question.word) return; 
        const existingIndex = wrongAnswerBank.findIndex(q => q.word === question.word);
        if (existingIndex === -1) {
            wrongAnswerBank.push(question);
            saveWrongAnswerBank();
        }
    }

    function removeWrongAnswer(question) {
        if (!question.word) return;
        const existingIndex = wrongAnswerBank.findIndex(q => q.word === question.word);
        if (existingIndex > -1) {
            wrongAnswerBank.splice(existingIndex, 1);
            saveWrongAnswerBank();
        }
    }
    
    function renderWrongQuizButton() {
        const count = wrongAnswerBank.length;
        if (count > 0) {
            startWrongQuizBtn.disabled = false;
            startWrongQuizBtn.innerHTML = `<i class="fas fa-redo mr-2"></i> í‹€ë¦° ë¬¸ì œ (${count}ê°œ) ë‹¤ì‹œ í’€ê¸°`;
            wrongQuizMessage.textContent = '';
        } else {
            startWrongQuizBtn.disabled = true;
            startWrongQuizBtn.innerHTML = `<i class="fas fa-redo mr-2"></i> í‹€ë¦° ë¬¸ì œ (0ê°œ) ë‹¤ì‹œ í’€ê¸°`;
            wrongQuizMessage.textContent = 'í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.';
            wrongQuizMessage.className = 'text-sm mt-2 h-4 text-center text-gray-500';
        }
    }
    
    function loadHistory() {
        const stored = localStorage.getItem(HISTORY_KEY);
        quizHistory = stored ? JSON.parse(stored) : [];
    }
    
    function saveHistory() {
        quizHistory = quizHistory.slice(0, 1000); 
        localStorage.setItem(HISTORY_KEY, JSON.stringify(quizHistory));
    }
    
    function addHistoryEntry(entry) {
        quizHistory.unshift(entry); 
        saveHistory();
    }
    
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        return `${date.getFullYear()}. ${date.getMonth() + 1}. ${date.getDate()}.(${days[date.getDay()]}) ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function renderHistory() {
        historyList.innerHTML = '';
        if (quizHistory.length === 0) {
            noHistoryList.classList.remove('hidden');
        } else {
            noHistoryList.classList.add('hidden');
            quizHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const score = item.total > 0 ? Math.round((item.correct / item.total) * 100) : 0;
                div.innerHTML = `
                    <span class="timestamp">${formatTimestamp(item.timestamp)}</span>
                    <div class="details">
                        <strong>${item.quizName}</strong>
                        (${item.total}ë¬¸ì œ ì¤‘ ${item.correct}ê°œ ì •ë‹µ, ${item.wrong}ê°œ ì˜¤ë‹µ)
                        <span class="score-badge">${score}ì </span>
                    </div>
                `;
                historyList.appendChild(div);
            });
        }
    }
    
    // --- v5: ë°œìŒ ê¸°í˜¸ ê²€ìƒ‰ í•¨ìˆ˜ ---
    async function fetchPhonetic(word) {
        phoneticLoader.style.display = 'block';
        fetchPhoneticBtn.disabled = true;
        
        // ë¬´ë£Œ ì‚¬ì „ API (dictionaryapi.dev) ì‚¬ìš©
        const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`;
        try {
            // 3ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) {
                newPhoneticInput.value = '';
                manualAddMessage.textContent = 'ë°œìŒ ê¸°í˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                manualAddMessage.className = 'text-sm text-yellow-600 mt-2 h-4';
                return null;
            }
            const data = await response.json();
            
            if (data[0] && data[0].phonetics) {
                // IPA ë°œìŒ ê¸°í˜¸ í…ìŠ¤íŠ¸ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì°¾ìŒ
                const phoneticMatch = data[0].phonetics.find(p => p.text);
                if (phoneticMatch && phoneticMatch.text) {
                    newPhoneticInput.value = phoneticMatch.text; // ì˜ˆ: /Ã¦pÉ™l/
                    manualAddMessage.textContent = 'ë°œìŒ ê¸°í˜¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.';
                    manualAddMessage.className = 'text-sm text-green-600 mt-2 h-4';
                    return phoneticMatch.text;
                }
            }
            newPhoneticInput.value = '';
            manualAddMessage.textContent = 'ë°œìŒ ê¸°í˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            manualAddMessage.className = 'text-sm text-yellow-600 mt-2 h-4';
            return null;
        } catch (error) {
            if (error.name === 'AbortError') {
                 manualAddMessage.textContent = 'ë°œìŒ ê²€ìƒ‰ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                 manualAddMessage.className = 'text-sm text-red-500 mt-2 h-4';
            } else {
                console.error("Phonetic fetch error:", error);
                manualAddMessage.textContent = 'ë°œìŒ ê¸°í˜¸ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.';
                manualAddMessage.className = 'text-sm text-red-500 mt-2 h-4';
            }
            return null;
        } finally {
            phoneticLoader.style.display = 'none';
            fetchPhoneticBtn.disabled = false;
        }
    }
    
    // --- v5: OCR (Gemini) í•¨ìˆ˜ ---
    
    // 1. ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function imageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); // 'data:image/jpeg;base64,' ë¶€ë¶„ ì œê±°
            reader.onerror = error => reject(error);
        });
    }

    // 2. Gemini API í˜¸ì¶œ í•¨ìˆ˜
    async function callGeminiApi(base64ImageData) {
        // [2025-08-26] ìš”ì²­ì— ë”°ë¼ API í‚¤ëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ë‘¡ë‹ˆë‹¤.
        const apiKey = ""; // ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [
                {
                    role: "user",
                    parts: [
                        // Geminiì—ê²Œ ì›í•˜ëŠ” JSON í˜•ì‹ì„ ëª…í™•í•˜ê²Œ ì§€ì‹œí•©ë‹ˆë‹¤.
                        { text: "Analyze this image of a vocabulary note. Extract the English word and its Korean meaning. Provide the output *only* in JSON format like {\"word\": \"EnglishWord\", \"meaning\": \"KoreanMeaning\"}. If you cannot find a clear word/meaning pair, return {\"word\": \"\", \"meaning\": \"\"}." },
                        {
                            inlineData: {
                                mimeType: "image/jpeg", // ê¸°ë³¸ JPEG, PNGë„ ê°€ëŠ¥
                                data: base64ImageData
                            }
                        }
                    ]
                }
            ],
            generationConfig: {
                // Geminiê°€ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ë„ë¡ ê°•ì œí•©ë‹ˆë‹¤.
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "word": { "type": "STRING" },
                        "meaning": { "type": "STRING" }
                    },
                    propertyOrdering: ["word", "meaning"]
                }
            }
        };
        
        // API í˜¸ì¶œ (ì§€ì—°/ì˜¤ë¥˜ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¬ì‹œë„ í¬í•¨)
        let response;
        let retries = 3;
        let delay = 1000;

        while (retries > 0) {
            try {
                // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        return JSON.parse(jsonText); // {word: "...", meaning: "..."}
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } else if (response.status === 429 || response.status >= 500) {
                    // API ê³¼ë¶€í•˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„
                    console.warn(`API call failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Exponential backoff
                    retries--;
                } else {
                    // 400 Bad Request ë“± ì¬ì‹œë„ê°€ ì˜ë¯¸ ì—†ëŠ” ì˜¤ë¥˜
                    throw new Error(`API call failed with status: ${response.status}`);
                }
            } catch (error) {
                console.error("Gemini API error:", error);
                retries--;
                if (retries <= 0) {
                    return null; // ìµœì¢… ì‹¤íŒ¨
                }
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }
        return null; // ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨
    }


    // --- 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    
    startQuizBtn.addEventListener('click', () => {
        const { questions, title } = getCombinedQuestions();
        startQuiz(questions, title + " í€´ì¦ˆ");
    });
    
    startLearnBtn.addEventListener('click', () => {
        const { questions, title } = getCombinedQuestions();
        startStudy(questions, title + " í•™ìŠµ");
    });

    // í€´ì¦ˆ í™”ë©´
    nextBtn.addEventListener('click', handleNextButton);
    retryBtn.addEventListener('click', () => startQuiz(activeQuizData, quizTitleEl.textContent)); 
    backToMainBtn.addEventListener('click', showMainScreen);

    // v2: í”Œë˜ì‹œì¹´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    flashcard.addEventListener('click', flipCard);
    prevCardBtn.addEventListener('click', showPrevCard);
    nextCardBtn.addEventListener('click', showNextCard);
    exitStudyBtn.addEventListener('click', showStudySummary);
    startQuizFromSummaryBtn.addEventListener('click', () => startQuiz(activeStudyData, flashcardTitle.textContent + " í€´ì¦ˆ"));
    mainFromSummaryBtn.addEventListener('click', showMainScreen);

    // v3: ë‹¨ì–´ì¥ ëª©ë¡ ë° ìƒì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    quizList.addEventListener('change', (e) => {
        if (e.target.classList.contains('quiz-select-cb')) {
            const checkedBoxes = quizList.querySelectorAll('.quiz-select-cb:checked');
            if (checkedBoxes.length > 0) {
                startLearnBtn.disabled = false;
                startQuizBtn.disabled = false;
                selectionMessage.textContent = `${checkedBoxes.length}ê°œ ë‹¨ì–´ì¥ ì„ íƒë¨`;
            } else {
                startLearnBtn.disabled = true;
                startQuizBtn.disabled = true;
                selectionMessage.textContent = '';
            }
        }
    });

    quizList.addEventListener('click', (e) => {
        const target = e.target.closest('.delete-quiz-btn');
        if (target) {
            const index = parseInt(target.dataset.index, 10);
            savedWordLists.splice(index, 1);
            saveWordLists();
            renderWordList();
            startLearnBtn.disabled = true; 
            startQuizBtn.disabled = true;
            selectionMessage.textContent = '';
        }
    });

    // ì•„ì½”ë””ì–¸ ë©”ë‰´ (ì ‘ê¸°/í¼ì¹˜ê¸°)
    accordionHeaderNewQuiz.addEventListener('click', () => {
        accordionHeaderNewQuiz.classList.toggle('open');
        accordionContentNewQuiz.classList.toggle('open');
    });

    // v5: 'ë‹¨ì–´ ì¶”ê°€' ë²„íŠ¼ (ë°œìŒ ê¸°í˜¸ í¬í•¨)
    addWordBtn.addEventListener('click', () => {
        const word = newWordInput.value.trim();
        const meaning = newMeaningInput.value.trim();
        const phonetic = newPhoneticInput.value.trim(); // v5

        if (word && meaning) {
            if (tempWords.find(w => w.word.toLowerCase() === word.toLowerCase())) {
                manualAddMessage.textContent = `'${word}'ëŠ”(ì€) ì´ë¯¸ ì¶”ê°€ëœ ë‹¨ì–´ì…ë‹ˆë‹¤.`;
                manualAddMessage.className = 'text-sm text-yellow-600 mt-2 h-4';
                return;
            }
            tempWords.push({ word, meaning, hint: '', phonetic: phonetic || null }); // v5
            renderTempWordList();
            newWordInput.value = '';
            newMeaningInput.value = '';
            newPhoneticInput.value = ''; // v5
            newWordInput.focus();
            manualAddMessage.textContent = `'${word}' ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            manualAddMessage.className = 'text-sm text-green-600 mt-2 h-4';
        } else {
            manualAddMessage.textContent = 'ë‹¨ì–´ì™€ ì˜ë¯¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            manualAddMessage.className = 'text-sm text-red-500 mt-2 h-4';
        }
    });

    tempWordListDiv.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-temp-word-btn');
        if (deleteBtn) {
            const wordToDelete = deleteBtn.dataset.word;
            tempWords = tempWords.filter(w => w.word !== wordToDelete);
            renderTempWordList();
            manualAddMessage.textContent = `'${wordToDelete}' ë‹¨ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
            manualAddMessage.className = 'text-sm text-yellow-600 mt-2 h-4';
        }
    });

    saveNewQuizBtn.addEventListener('click', () => {
        const name = newQuizNameInput.value.trim();
        if (!name) {
            manualAddMessage.textContent = 'ë‹¨ì–´ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            manualAddMessage.className = 'text-sm text-red-500 mt-2 h-4';
            return;
        }
        if (tempWords.length < 4) {
            manualAddMessage.textContent = 'í€´ì¦ˆ ìƒì„±ì„ ìœ„í•´ ìµœì†Œ 4ê°œì˜ ë‹¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
            manualAddMessage.className = 'text-sm text-red-500 mt-2 h-4';
            return;
        }
        const newQuestions = generateQuizFromWords(tempWords);
        const newQuizSet = { name, questions: newQuestions };
        const existingIndex = savedWordLists.findIndex(q => q.name === name);
        if (existingIndex > -1) {
             savedWordLists[existingIndex] = newQuizSet;
             manualAddMessage.textContent = `'${name}' ë‹¨ì–´ì¥ì„ ë®ì–´ì¼ìŠµë‹ˆë‹¤.`;
             manualAddMessage.className = 'text-sm text-yellow-600 mt-2 h-4';
        } else {
            savedWordLists.push(newQuizSet);
             manualAddMessage.textContent = `'${name}' ë‹¨ì–´ì¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`;
             manualAddMessage.className = 'text-sm text-green-600 mt-2 h-4';
        }
        saveWordLists();
        renderWordList();
        tempWords = [];
        newQuizNameInput.value = '';
        renderTempWordList();
    });
    
    // --- v4: ë­í‚¹, ê¸°ë¡, ì˜¤ë‹µë…¸íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    
    // 'input' ëŒ€ì‹  'change' ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬, ì…ë ¥ì´ ì™„ë£Œëœ í›„ (í¬ì»¤ìŠ¤ë¥¼ ìƒì—ˆì„ ë•Œ) ì €ì¥í•©ë‹ˆë‹¤.
    playerNameInput.addEventListener('change', (e) => {
        savePlayerName(e.target.value);
    });
    
    accordionHeaderOndap.addEventListener('click', () => {
        accordionHeaderOndap.classList.toggle('open');
        accordionContentOndap.classList.toggle('open');
    });
    
    accordionHeaderHistory.addEventListener('click', () => {
        accordionHeaderHistory.classList.toggle('open');
        accordionContentHistory.classList.toggle('open');
    });
    
    startWrongQuizBtn.addEventListener('click', () => {
        if (wrongAnswerBank.length === 0) {
            wrongQuizMessage.textContent = 'ë‹¤ì‹œ í’€ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.';
            wrongQuizMessage.className = 'text-sm mt-2 h-4 text-center text-red-500';
            return;
        }
        let questionsToQuiz = [...wrongAnswerBank];
        shuffleArray(questionsToQuiz);
        startQuiz(questionsToQuiz, "í‹€ë¦° ë¬¸ì œ í€´ì¦ˆ");
    });
    
    clearHistoryBtn.addEventListener('click', () => {
        quizHistory = [];
        saveHistory();
        renderHistory();
    });
    
    // --- v5: ê³ ê¸‰ ê¸°ëŠ¥ ë¦¬ìŠ¤ë„ˆ ---
    
    // ë°œìŒ ê¸°í˜¸ ìë™ ê²€ìƒ‰
    fetchPhoneticBtn.addEventListener('click', () => {
        const word = newWordInput.value.trim();
        if (word) {
            fetchPhonetic(word);
        } else {
            manualAddMessage.textContent = 'ì˜ì–´ ë‹¨ì–´ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.';
            manualAddMessage.className = 'text-sm text-red-500 mt-2 h-4';
        }
    });

    // OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ
    ocrExtractBtn.addEventListener('click', async () => {
        const file = ocrImageInput.files[0];
        if (!file) {
            ocrMessage.textContent = 'ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.';
            ocrMessage.className = 'text-sm text-red-500 mt-2 h-4';
            return;
        }

        ocrMessage.textContent = 'AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
        ocrMessage.className = 'text-sm text-blue-600 mt-2 h-4';
        ocrExtractBtn.disabled = true;

        try {
            const base64Data = await imageToBase64(file);
            const result = await callGeminiApi(base64Data);

            if (result && result.word && result.meaning) {
                newWordInput.value = result.word;
                newMeaningInput.value = result.meaning;
                ocrMessage.textContent = 'í…ìŠ¤íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤!';
                ocrMessage.className = 'text-sm text-green-600 mt-2 h-4';
                // ì¶”ì¶œ í›„ ìë™ìœ¼ë¡œ ë°œìŒ ê¸°í˜¸ ê²€ìƒ‰
                if (result.word) {
                    fetchPhonetic(result.word);
                }
            } else {
                ocrMessage.textContent = 'ì´ë¯¸ì§€ì—ì„œ ë‹¨ì–´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                ocrMessage.className = 'text-sm text-yellow-600 mt-2 h-4';
            }
        } catch (error) {
            console.error("OCR Error:", error);
            ocrMessage.textContent = 'í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            ocrMessage.className = 'text-sm text-red-500 mt-2 h-4';
        } finally {
            ocrExtractBtn.disabled = false;
            ocrImageInput.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        }
    });

    // --- 6. ì´ˆê¸°í™” ---
    loadWordLists();
    loadPlayerName();
    loadRankings();
    loadWrongAnswerBank();
    loadHistory();
    
    renderWordList();
    renderRankings();
    renderWrongQuizButton();
    renderHistory();
    renderTempWordList(); 

</script>
</body>
</html>
