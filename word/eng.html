<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>외워</title>
  <!-- <link rel="stylesheet" href="style.css" /> --><!-- 원본 CSS 링크 대신 아래 style 태그에 내용을 통합합니다 -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* === style.css 파일 내용 시작 === */
    :root{
      --bg:#f7f8fb;
      --card:#fff;
      --text:#222;
      --muted:#7a7f8a;
      --border:#e2e5ea;
      --primary:#4f46e5;
      --danger:#e11d48;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .app-title{font-size:36px;text-align:center;margin-bottom:20px}
    .card{
      background:var(--card); 
      border:1px solid #e5e7eb; /* Set 2 스타일 적용 */
      border-radius:14px; /* Set 2 스타일 적용 */
      padding:18px; /* Set 2 스타일 적용 */
      margin:16px 0;
      box-shadow: 0 6px 20px rgba(17, 24, 39, 0.04); /* Set 2 스타일 적용 */
    }
    .card-header{display:flex;align-items:center;justify-content:space-between}
    .label{display:block;font-weight:600;margin-bottom:6px}
    .input{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px;
      background:#fff; outline:none;
    }
    .input:focus{border-color:var(--primary); box-shadow:0 0 0 3px #4f46e533}
    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:10px 14px; border-radius:8px; border:1px solid var(--border);
      background:#fff; cursor:pointer;
    }
    .btn:hover{background:#fafafa}
    .btn-xs{padding:6px 10px;font-size:13px}
    .btn-primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .btn-primary:hover{filter:brightness(0.98)}
    .btn-danger{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .muted{color:var(--muted)}
    .h-4{min-height:1.25rem}

    /* quiz list */
    .quiz-list>div{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid var(--border); border-radius:10px; padding:12px; margin:10px 0; background:#fff;
    }
    .quiz-item-label{display:flex;flex-direction:column;gap:4px;margin-left:8px}
    .quiz-item-buttons{display:flex;gap:8px}
    .actions{
      /* display:flex; <-- 변경 */
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px
    }
    .actions .btn {
      width: 100%; /* 버튼이 그리드 셀을 꽉 채우도록 */
    }

    /* accordion */
    /* [수정됨] 스크린샷 디자인(단순 구분선)에 맞게 수정 */
    .accordion{
      margin: 0;
      border-bottom: 1px solid var(--border, #e5e7eb);
    }
    /* '오답노트'가 main 안의 첫번째 accordion이므로 상단에도 선 추가 */
    main.container > .accordion:nth-of-type(3) { /* player, ranking card 다음에 오는 첫 accordion */
       border-top: 1px solid var(--border, #e5e7eb);
    }

    .accordion-header{
      width:100%; 
      padding:16px 8px; /* 패딩 조정 */
      text-align:left; 
      border:none; 
      background:none; /* 배경 없음 */
      font-weight:700; 
      font-size: 18px; /* 폰트 크기 키움 */
      color: #1f2937; /* 텍스트 색상 */
      cursor:pointer;
      display:flex; 
      align-items:center;
      justify-content:space-between;
      position: relative; /* for ::after */
    }
    
    /* 아코디언 헤더 화살표 아이콘 */
    .accordion-header::after {
      content: '\f078'; /* font-awesome down arrow */
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      font-size: 14px;
      color: #6b7280; /* muted grey */
      transition: transform 0.25s ease;
    }

    /* 아코디언 열렸을 때 화살표 회전 */
    .accordion-header.open::after {
      transform: rotate(-180deg);
    }

    .accordion-content{
      max-height: 0; /* [수정] JS 토글을 위해 max-height로 변경 */
      overflow: hidden;
      transition: max-height .25s ease;
      padding: 0 8px; /* 0 16px -> 0 8px */
      display: block; /* [수정] display:none -> block */
    }
    .accordion-header.open + .accordion-content,
    .accordion-content.open{
      max-height: 1000px; /* 넉넉한 값 */
      padding: 0px 8px 16px 8px; /* 14px 16px -> 0 8px 16px 8px */
    }

    /* * [수정됨] 
     * 오버레이(퀴즈/플래시카드) 스타일 수정
     * * 1. .overlay 자체에 display:flex (보이기)를 기본으로 설정합니다.
     * (기존에는 display:none 이었습니다)
     * 2. .overlay:not(.hidden) 규칙을 삭제합니다.
     * 3. .hidden { display:none !important; } 규칙 (파일 맨 아래 있음)이
     * .overlay.hidden 상태일 때 오버레이를 숨기는 역할을 전담합니다.
     */
    .overlay{
      position:fixed;
      inset:0;
      /* display:none; <-- 이 부분을 flex로 변경 */
      display:flex; 
      align-items:center;
      justify-content:center;
      background:#00000066; /* 반투명 검은 배경 */
      padding:16px;
      z-index: 100; /* 다른 요소들 위에 보이도록 z-index 추가 */
    }
    .overlay .quiz,.flashcard-wrap,.card{
      max-width:720px;
      width:100%;
      /* 오버레이 안의 카드가 배경색을 갖도록 보장 */
      background: var(--card, #fff); 
    }
    /* .overlay:not(.hidden){display:flex} <-- 이 규칙은 삭제 (위에서 .overlay에 display:flex를 직접 줬기 때문) */


    /* quiz */
    .question{font-size:22px;margin:12px 0}
    .options{display:grid;gap:10px}
    .option-btn{padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .option-btn.correct{background:#10b98122;border-color:#10b981}
    .option-btn.wrong{background:#ef444422;border-color:#ef4444}
    .rationale{margin-top:8px}
    .nav{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px}

    /* flashcard */
    .flashcard-scene{perspective:900px;height:240px;margin:10px 0}
    .flashcard{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .5s}
    .flashcard.is-flipped{transform:rotateY(180deg)}
    .flashcard-face{
      position:absolute; inset:0; backface-visibility:hidden;
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      background:#fff;border:1px solid var(--border);border-radius:12px
    }
    .flashcard-face.back{transform:rotateY(180deg)}

    /* lists */
    .list>div{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--border);border-radius:8px;padding:10px;margin:6px 0;background:#fff
    }
    .list .icon-btn{border:none;background:none;color:#ef4444;font-size:18px;cursor:pointer}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:#0006; z-index: 190;}
    .modal{
      position:fixed; inset:50% auto auto 50%; transform:translate(-50%,-50%);
      width:min(720px,calc(100% - 24px)); background:#fff; border:1px solid var(--border); border-radius:12px;
      display:flex;flex-direction:column; max-height:85vh; overflow:auto;
      z-index: 200;
    }
    .modal.hidden,.modal-backdrop.hidden{display:none}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal-body{padding:12px 16px}
    .modal-footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    /* .icon-btn{border:none;background:#fff;padding:6px 8px;border-radius:8px;cursor:pointer} <-- .list .icon-btn과 중복/충돌 가능성 있어 .list 내부로 한정 */
    .modal-header .icon-btn { border:none; background:transparent; font-size: 18px; cursor: pointer; }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .loader{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#333;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}


    /* =========================
       UI 폴리시 · 리스팅/버튼 리스타일
       ========================= */

    /* 카드 공통 (박스) */
    .section-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 6px 20px rgba(17, 24, 39, 0.04);
    }
    /* .card 클래스와 스타일이 중복되므로 .section-card 대신 .card 사용 권장. 여기서는 유지. */


    /* 섹션 헤더 */
    .section-title {
      font-size: 20px;
      font-weight: 800;
      color: #111827;
      margin: 2px 0 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* 단어장 리스트 행 */
    #quiz-list > div {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border: 1px solid #eef0f4;
      border-radius: 12px;
      background: #ffffff;
      margin-bottom: 10px;
      transition: transform .06s ease, box-shadow .1s ease, border-color .1s ease;
      /* .quiz-list>div 스타일 중복 정의. 아래쪽 스타일이 덮어씀 */
    }
    #quiz-list > div:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(17, 24, 39, 0.06);
      border-color: #e5e7eb;
    }

    /* 체크박스 영역 */
    #quiz-list .quiz-select-cb {
      width: 18px;
      height: 18px;
      accent-color: #2563eb;
    }

    /* 레이블(이름 + 날짜) */
    #quiz-list .quiz-item-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1 1 auto;
      cursor: pointer;
      margin-left: 0; /* 스타일 충돌 수정 */
    }
    #quiz-list .quiz-item-label > span {
      font-weight: 700;
      color: #111827;
    }
    #quiz-list .quiz-item-date {
      font-size: 12px;
      color: #6b7280;
    }

    /* 버튼 그룹 (오른쪽) */
    #quiz-list .quiz-item-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* 버튼 베이스 */
    .btn {
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background .15s ease, border-color .15s ease, color .15s ease, transform .05s ease;
      user-select: none;
      /* .btn 스타일 중복 정의. 아래쪽 스타일이 덮어씀 */
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }

    /* 라지 액션(학습/퀴즈/랜덤) */
    .btn-lg {
      padding: 14px 20px;
      border-radius: 14px;
      font-size: 16px;
    }

    /* sm/xs */
    .btn-sm { padding: 8px 12px; font-size: 14px; }
    /* .btn-xs는 위에도 정의되어 있지만, 아래쪽 스타일이 우선 적용됨 */
    .btn-xs { padding: 6px 10px; font-size: 13px; } 

    /* 버튼 스타일 */
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-primary:hover { background:#1d4ed8; }

    .btn-secondary {
      background: #f3f4f6;
      color: #1f2937;
      border-color: #e5e7eb;
    }
    .btn-secondary:hover { background:#e9ecf1; }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }
    .btn-danger:hover { background:#fdd8d8; }

    /* 리스트 내부 edit/delete 아이콘 버튼 */
    #quiz-list .btn.btn-xs {
      min-width: 36px;
      justify-content: center;
      border-radius: 10px;
    }

    /* 상단 입력 */
    input[type="text"],
    input[type="search"],
    input.input /* .input 스타일 덮어쓰기 */ {
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 12px 14px;
      border-radius: 12px;
      width: 100%;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input[type="text"]:focus,
    input[type="search"]:focus,
    input.input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, .10);
    }
    /* input 태그 간 여백 추가 */
    input.input + input.input {
      margin-top: 8px;
    }


    /* 학습/퀴즈/랜덤 버튼 행 */
    .action-row {
      display: flex;
      gap: 18px;
      margin-top: 14px;
    }
    .action-row .btn { flex: 1 1 0; }
    /* .actions에도 flex가 적용되어 있으므로 .action-row는 현재 HTML 구조에서 사용되지 않음 */

    /* 안내 텍스트 */
    #selection-message {
      margin-top: 6px;
      min-height: 18px;
    }

    <!-- ... (약 101줄의 코드) ... -->
    }

    /* accordion */
    /* [수정됨] 스크린샷(de6c76.png) 디자인(카드형 아코디언)으로 복구 */
    .accordion{
      background:var(--card); 
      border:1px solid #e5e7eb; 
      border-radius:14px; 
      margin:16px 0;
      box-shadow: 0 6px 20px rgba(17, 24, 39, 0.04); 
      overflow: hidden; /* radius가 content에 적용되도록 */
    }

    .accordion-header{
      width:100%; 
      padding: 18px; /* .card와 동일한 padding */
      text-align:left; 
      border:none; 
      background:none; 
      font-weight:700; 
      font-size: 18px; 
      color: #1f2937; 
      cursor:pointer;
      display:flex; 
      align-items:center;
      justify-content:space-between;
      position: relative; 
    }
    
    /* 아코디언 헤더 화살표 아이콘 */
    .accordion-header::after {
      content: '\f078'; /* font-awesome down arrow */
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      font-size: 14px;
      color: #6b7280; /* muted grey */
      transition: transform 0.25s ease;
    }

    /* 아코디언 열렸을 때 화살표 회전 */
    .accordion-header.open::after {
      transform: rotate(-180deg);
    }

    .accordion-content{
      max-height: 0; 
      overflow: hidden;
      transition: max-height .25s ease, padding .25s ease;
      padding: 0 18px; /* .card와 동일한 좌우 padding */
      display: block; 
      border-top: none;
    }
    
    .accordion-header.open + .accordion-content,
    .accordion-content.open{
      max-height: 1000px; /* 넉넉한 값 */
      padding: 0px 18px 18px 18px; /* 상단 제외, .card와 동일한 padding */
      border-top: 1px solid #eef0f4; /* 헤더와 컨텐츠 구분선 */
    }


    /* * [수정됨] 
     * 오버레이(퀴즈/플래시카드) 스타일 수정
<!-- ... (약 169줄의 코드) ... -->
    /* 안내 텍스트 */
    #selection-message {
      margin-top: 6px;
      min-height: 18px;
    }

    /* [수정됨] 이전에 중복 정의되었던 아코디언 스타일을 (line 103 부근으로) 통합하고 이 섹션은 삭제합니다. */
    


    /* 결과/오답 리스트 기본 */
    #wrong-answers-list ul {
        margin-top: 10px;
      padding-left: 18px;
    }
    #wrong-answers-list li {
      list-style: disc;
      margin: 4px 0;
    }

    /* 모바일 여백 */
    @media (max-width: 480px) {
      #quiz-list > div { padding: 12px 12px; }
      .btn-lg { padding: 12px 14px; }
      /* 메인 버튼 모바일에서 세로로 쌓기 */
      .actions { grid-template-columns: 1fr; }
    }

    /* * [수정됨]
     * .hidden 클래스가 !important를 가지므로, 
     * .overlay:not(.hidden) 보다 우선순위가 높아 
     * 오버레이가 보이지 않는 문제를 해결하기 위해
     * .overlay 자체에 display:flex를 주고, 
     * .hidden 클래스가 모든 것을 덮어쓰도록 보장합니다.
     */
    .hidden{ display:none !important; }
    
    /* === style.css 파일 내용 끝 === */

    /* =========================
       스크린샷 디자인용 추가 CSS
       ========================= */
    
    /* 퀴즈 선택지 버튼 (Set 1 override) */
    .option-btn {
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      font-size: 16px;
      background: #fff;
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 12px;
      cursor: pointer;
      transition: background .15s ease;
      /* .btn-secondary의 스타일을 일부 가져옴 */
      color: #1f2937; 
      font-weight: 700;
    }
    .option-btn:hover {
      background: #f9fafb;
    }
    .option-btn.correct {
      background: #dcfce7 !important; 
      color: #166534;
      border-color: #bbf7d0;
    }
    .option-btn.wrong {
      background: #fee2e2 !important;
      color: #991b1b;
      border-color: #fecaca;
    }

    /* 퀴즈 네비게이션 버튼 */
    #quiz-content .nav {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      width: 100%;
      margin-top: 20px;
    }
    #quiz-content .nav .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      /* .btn-xs 클래스 오버라이드 */
    }
    #quiz-prev-arrow { 
      background: #f3f4f6;
      color: #1f2937;
      border-color: #e5e7eb;
    }
    #quiz-next-arrow { 
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    #quiz-prev-arrow:disabled,
    #quiz-next-arrow:disabled {
      background: #f3f4f6;
      color: #9ca3af;
      border-color: #e5e7eb;
      opacity: .6;
    }


    /* 결과 화면 네비게이션 버튼 */
    #result .nav {
      margin-top: 20px;
      gap: 12px;
    }
    #retry-btn {
      background: #4ade80; /* Green */
      color: white;
      border-color: #4ade80;
    }
    #retry-btn:hover { background: #36b96f; }
    #back-to-main-btn {
      background: #6b7280; /* Dark Grey */
      color: white;
      border-color: #6b7280;
    }
    #back-to-main-btn:hover { background: #5a646e; }

    /* 학습 요약 네비게이션 버튼 */
    #study-complete-container .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      margin-top: 16px;
    }
    #study-complete-container .actions .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
    }
    #study-complete-container #main-from-summary-btn { /* Style the grey button */
        background: #6b7280; 
        color: white; 
        border-color: #6b7280;
    }
    #study-complete-container #main-from-summary-btn:hover { background: #5a646e; }
    
    /* 플래시카드 네비게이션 버튼 */
    #flashcard-container .nav {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      width: 100%;
      align-items: center;
      margin-top: 16px;
    }
    #flashcard-container .nav .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
    }
    #card-prev-arrow {
      background: #f3f4f6; color: #1f2937; border-color: #e5e7eb;
    }
    #card-next-arrow {
      background: #2563eb; color: white; border-color: #2563eb;
    }
    #card-prev-arrow:disabled,
    #card-next-arrow:disabled {
      background: #f3f4f6;
      color: #9ca3af;
      border-color: #e5e7eb;
      opacity: .6;
    }

  </style>
</head>
<body>
  <main class="container">
    <h1 class="app-title">영어 단어</h1>

    <!-- 학습자 이름/랭킹 -->
    <section class="card">
      <label class="label">학습자 이름</label>
      <input id="player-name" class="input" placeholder="이름을 입력하세요 (랭킹/기록용)" />
    </section>

    <section class="card">
      <div class="card-header">
        <h2><i class="fa-solid fa-trophy"></i> 학습 랭킹</h2>
        <button id="ranking-reset-btn" class="btn btn-danger btn-xs">
          <i class="fa-solid fa-trash"></i> 랭킹 초기화
        </button>
      </div>
      <div id="no-ranking-list" class="muted"></div>
      <div id="ranking-list" class="ranking-list"></div>
    </section>

    <!-- 단어장 목록 -->
    <section class="card">
      <h2>단어장 목록</h2>
      <p class="muted">학습할 단어장을 선택하세요. (1개 이상)</p>

      <div id="quiz-list" class="quiz-list"></div>
      <p id="no-quiz-list" class="muted">저장된 단어장이 없습니다.</p>

      <div class="actions">
        <button id="start-learn-btn" class="btn btn-lg btn-secondary" disabled>
          <i class="fa-solid fa-book-open"></i> 학습
        </button>
        <button id="start-quiz-btn" class="btn btn-lg btn-primary" disabled>
          <i class="fa-solid fa-pen"></i> 퀴즈
        </button>
        <button id="start-random-quiz-btn" class="btn btn-lg btn-secondary" disabled style="display:none;">
          <i class="fa-solid fa-shuffle"></i> 랜덤(10)
        </button>
      </div>
      <div id="selection-message" class="muted h-4"></div> <!-- 높이 보장용 h-4 추가 -->
    </section>

    <!-- 오답노트 -->
    <section class="accordion">
      <button id="accordion-header-ondap" class="accordion-header">오답노트</button>
      <div id="accordion-content-ondap" class="accordion-content">
        <button id="start-wrong-quiz-btn" class="btn" disabled>
          <i class="fa-solid fa-redo"></i> 틀린 문제 (0개) 다시 풀기
        </button>
        <p id="wrong-quiz-message" class="muted"></p>
      </div>
    </section>

    <!-- 새 단어장 만들기 (AI/수동) -->
    <section class="accordion">
      <button id="accordion-header-new-quiz" class="accordion-header">새 단어장 직접 만들기 (AI)</button>
      <div id="accordion-content-new-quiz" class="accordion-content">
        <div class="grid">
          <div>
            <h3>OCR → 자동 추가 (기능 준비중)</h3>
            <input id="ocr-image-input" type="file" accept="image/*" disabled />
            <button id="ocr-extract-btn" class="btn" disabled>이미지에서 단어 추출</button>
            <div id="ocr-message" class="ai-message muted"></div>

            <div class="mt-2" style="margin-top: 1rem;">
              <input id="new-word-auto" class="input" placeholder="영어 단어 (기능 준비중)" disabled />
              <button id="add-word-auto-btn" class="btn" disabled>자동 추가</button>
              <span id="auto-add-loader" class="loader" style="display:none;"></span>
              <div id="auto-add-message" class="ai-message"></div>
            </div>
          </div>

          <div>
            <h3>수동 추가</h3>
            <input id="new-word-manual" class="input" placeholder="영어 단어" />
            <input id="new-meaning-manual" class="input" placeholder="한국어 의미" />
            <input id="new-phonetic-manual" class="input" placeholder="발음 기호(선택)" />
            <button id="add-word-manual-btn" class="btn" style="margin-top: 8px;">이 단어 추가</button>
            <div id="manual-add-message" class="muted h-4"></div>
          </div>
        </div>

        <h3 class="mt-2" style="margin-top: 1rem;">현재 단어 목록 (<span id="temp-word-count">0</span>)</h3>
        <div id="temp-word-list" class="list"></div>

        <div class="mt-2" style="margin-top: 1rem;">
          <input id="new-quiz-name" class="input" placeholder="단어장 이름" />
          <button id="save-new-quiz-btn" class="btn btn-primary" style="margin-top: 8px;">단어장 저장</button>
        </div>
      </div>
    </section>

    <!-- 전체 학습 기록 -->
    <section class="accordion">
      <button id="accordion-header-history" class="accordion-header">전체 학습 기록</button>
      <div id="accordion-content-history" class="accordion-content">
        <div class="history-actions" style="margin-bottom: 10px;">
          <button id="clear-history-btn" class="btn btn-danger btn-xs">기록 모두 지우기</button>
        </div>
        <div id="history-list" class="history-list"></div>
        <div id="no-history-list" class="muted">학습 기록이 없습니다.</div>
      </div>
    </section>
  </main>

  <!-- 퀴즈 화면 -->
  <section id="quiz-container" class="overlay hidden">
    <!-- 
      [수정됨]
      퀴즈 오버레이 안의 .quiz가 .card 스타일을 상속받아 
      흰색 배경과 테두리를 갖도록 .card 클래스 추가
    -->
    <div class="card quiz"> 
      <div class="card-header quiz-header"> <!-- .card-header로 변경 -->
        <button id="home-btn" class="btn btn-xs btn-secondary">&larr; 홈</button>
        <h2 id="quiz-title" class="section-title" style="margin: 0;"></h2> <!-- .section-title로 변경 -->
        <button id="quit-btn" class="btn btn-danger btn-xs">그만하기</button>
      </div>

      <div id="quiz-content" style="padding: 16px 0;">
        <div id="progress" class="muted"></div>
        <h3 id="question" class="question"></h3>
        <div id="options" class="options"></div>
        <p id="rationale" class="rationale"></p>

        <div class="nav">
          <button id="quiz-prev-arrow" class="btn btn-xs btn-secondary" disabled>&larr; 이전</button>
          <button id="quiz-next-arrow" class="btn btn-xs btn-secondary" disabled>다음 &rarr;</button>
        </div>
      </div>

      <div id="result" class="hidden" style="padding: 16px 0;">
        <h3 id="score-display" class="section-title"></h3>
        <div id="wrong-answers-list"></div>
        <div class="nav">
          <button id="retry-btn" class="btn btn-primary">같은 문제 다시 풀기</button>
          <button id="back-to-main-btn" class="btn btn-secondary">메인으로</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 플래시카드 -->
  <section id="flashcard-container" class="overlay hidden">
    <!-- 
      [수정됨]
      플래시카드 오버레이 안의 .flashcard-wrap이 .card 스타일을 상속받도록
      .card 클래스 추가
    -->
    <div class="card flashcard-wrap">
      <div class="card-header fc-header"> <!-- .card-header로 변경 -->
        <!-- [수정됨] main-from-summary-btn는 요약 화면에만 있어야 하므로 삭제 -->
        <h2 id="flashcard-title" class="section-title" style="margin: 0;"></h2>
        <button id="exit-study-btn" class="btn btn-xs btn-secondary">요약 보기</button>
      </div>

      <div id="flashcard-scene" class="flashcard-scene">
        <div id="flashcard" class="flashcard">
          <div id="flashcard-front" class="flashcard-face front"></div>
          <div id="flashcard-back" class="flashcard-face back"></div>
        </div>
      </div>

      <div class="nav">
        <button id="card-prev-arrow" class="btn btn-xs btn-secondary" disabled>&larr; 이전</button>
        <span id="flashcard-progress" class="muted"></span>
        <button id="card-next-arrow" class="btn btn-xs btn-secondary" disabled>다음 &rarr;</button>
      </div>
    </div>
  </section>

  <!-- 
    [수정됨]
    HTML에 study-complete-container가 두 번 정의되어 있었습니다. (ID 중복)
    메인 컨텐츠 안의 div는 삭제하고, 오버레이 섹션만 남깁니다.
  -->
  <!-- 학습 요약 -->
  <section id="study-complete-container" class="overlay hidden">
    <div class="card">
      <h2 class="section-title">학습 요약</h2>
      <ul id="study-summary-list" class="list" style="max-height: 300px; overflow-y: auto; margin: 10px 0; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></ul>
      <div class="actions" style="justify-content: flex-end;"> <!-- flex-end 추가 -->
        <button id="start-quiz-from-summary-btn" class="btn btn-primary">이 단어로 퀴즈</button>
        <button id="main-from-summary-btn" class="btn btn-secondary">메인으로</button>
      </div>
    </div>
  </section>

  <!-- 편집 모달 -->
  <div id="edit-modal-backdrop" class="modal-backdrop hidden"></div>
  <div id="edit-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3 id="edit-modal-title" class="section-title" style="margin: 0;">"단어장" 단어장 편집</h3>
      <button id="edit-modal-close-btn" class="icon-btn" aria-label="닫기"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="modal-body">
      <label class="label">단어장 이름</label>
      <input id="edit-quiz-name" class="input" />

      <h4 style="margin-top: 1rem;">단어 목록 (<span id="edit-word-count">0</span>)</h4>
      <div id="edit-word-list" class="list" style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></div>

      <h4 style="margin-top: 1rem;">새 단어 추가 (수동)</h4>
      <input id="edit-new-word" class="input" placeholder="영어 단어" />
      <input id="edit-new-meaning" class="input" placeholder="한국어 의미" />
      <input id="edit-new-phonetic" class="input" placeholder="발음 기호(선택)" />
      <button id="edit-add-word-btn" class="btn btn-secondary" style="margin-top: 8px;"><i class="fa-solid fa-plus"></i> 이 단어 추가</button>
      <div id="edit-manual-add-message" class="muted h-4"></div>
    </div>

    <div class="modal-footer">
      <button id="edit-modal-cancel-btn" class="btn btn-secondary">취소</button>
      <button id="edit-modal-save-btn" class="btn btn-primary">저장</button>
    </div>
  </div>

  <!-- <script src="script.js"></script> --><!-- 원본 JS 링크 대신 아래 script 태그에 내용을 통합합니다 -->
  <script>
    /* === script.js 파일 내용 시작 === */
    /************************************************************
     * 영어 단어 - 통합 스크립트 (안정 버전)
     * - 기본 단어장 고정 노출
     * - 새 단어장 생성/편집/삭제
     * - 학습/퀴즈/랜덤/오답/랭킹/기록
     ************************************************************/
    // --- 안전 가드(최상단에 추가) ---
    console.log('[word] script loaded');
    window.addEventListener('error', (e) => {
      // 초기 에러가 있으면 알림으로 바로 확인할 수 있게
      console.warn('Error captured:', e?.message);
    });
    // [수정됨] DOMContentLoaded 이벤트 핸들러가 script.js 파일이 로드되기 전에
    // 발생할 수 있으므로, 스크립트가 파일 하단에 위치할 때는
    // DOMContentLoaded를 기다리지 않고 바로 실행하거나,
    // 혹은 함수로 감싸서 DOMContentLoaded에서 호출해야 합니다.
    // 여기서는 파일 하단에 있으므로 DOM 로드가 완료되었다고 가정하고
    // 즉시 실행하는 로직으로 변경합니다. (별도 핸들러 제거)
    // --- 안전 가드 끝 ---

    /* ========================= 1) 기본 데이터 ========================= */
    const sampleQuizData1 = [
      { word:"rock", meaning:"바위", phonetic:"/rɑːk/", question:"rock", hint:"자연물", options:["모자","바위","문","인형"], correct:1, rationale:"'rock'은(는) '바위'를 의미합니다." },
      { word:"cap", meaning:"모자", phonetic:"/kæp/", question:"cap", hint:"의류", options:["모자","침대","노래하다","바위"], correct:0, rationale:"'cap'은(는) '모자'를 의미합니다." },
      { word:"death", meaning:"죽음", phonetic:"/dɛθ/", question:"death", hint:"생명의 반대", options:["인형","죽음","성냥","문"], correct:1, rationale:"'death'은(는) '죽음'을 의미합니다." },
      { word:"bed", meaning:"침대", phonetic:"/bɛd/", question:"bed", hint:"자는 곳", options:["모자","침대","문","바위"], correct:1, rationale:"'bed'은(는) '침대'를 의미합니다." },
      { word:"match", meaning:"성냥", phonetic:"/mætʃ/", question:"match", hint:"불을 붙이다", options:["성냥","문","노래하다","모자"], correct:0, rationale:"'match'은(는) '성냥'을 의미합니다." },
      { word:"sing", meaning:"노래하다", phonetic:"/sɪŋ/", question:"sing", hint:"목소리", options:["성냥","노래하다","바위","인형"], correct:1, rationale:"'sing'은(는) '노래하다'를 의미합니다." },
      { word:"doll", meaning:"인형", phonetic:"/dɒl/", question:"doll", hint:"장난감", options:["침대","인형","모자","성냥"], correct:1, rationale:"'doll'은(는) '인형'을 의미합니다." },
      { word:"door", meaning:"문", phonetic:"/dɔːr/", question:"door", hint:"건물 출입", options:["문","바위","모자","노래하다"], correct:0, rationale:"'door'은(는) '문'을 의미합니다." }
    ];
    const sampleQuizData2 = [
      { word:"coin", meaning:"동전", phonetic:"/kɔɪn/", question:"coin", hint:"돈", options:["동전","상어","시소","화장지"], correct:0, rationale:"'coin'은(는) '동전'을 의미합니다." },
      { word:"shark", meaning:"상어", phonetic:"/ʃɑːrk/", question:"shark", hint:"바다동물", options:["상어","동전","주","시소"], correct:0, rationale:"'shark'은(는) '상어'를 의미합니다." },
      { word:"smell", meaning:"냄새 맡다", phonetic:"/smɛl/", question:"smell", hint:"코", options:["상어","냄새 맡다","화장지","주"], correct:1, rationale:"'smell'은(는) '냄새 맡다'를 의미합니다." },
      { word:"seesaw", meaning:"시소", phonetic:"/ˈsiːˌsɔː/", question:"seesaw", hint:"놀이터", options:["시소","화장지","상어","동전"], correct:0, rationale:"'seesaw'은(는) '시소'를 의미합니다." },
      { word:"tray", meaning:"쟁반", phonetic:"/treɪ/", question:"tray", hint:"식사", options:["시소","쟁반","화장지","동전"], correct:1, rationale:"'tray'은(는) '쟁반'을 의미합니다." },
      { word:"snow", meaning:"눈", phonetic:"/snoʊ/", question:"snow", hint:"겨울", options:["눈","동전","상어","시소"], correct:0, rationale:"'snow'은(는) '눈'을 의미합니다." },
      { word:"tissue", meaning:"화장지", phonetic:"/ˈtɪʃuː/", question:"tissue", hint:"코 닦는 것", options:["시소","상어","화장지","동전"], correct:2, rationale:"'tissue'은(는) '화장지'를 의미합니다." },
      { word:"mouse", meaning:"쥐", phonetic:"/maʊs/", question:"mouse", hint:"작은 동물", options:["쥐","상어","화장지","눈"], correct:0, rationale:"'mouse'은(는) '쥐'를 의미합니다." }
    ];
    const sampleQuizData3 = [
      { word:"zebra", meaning:"얼룩말", phonetic:"/ˈziːbrə/", question:"zebra", hint:"줄무늬 동물", options:["포도","주머니","얼룩말","베개"], correct:2, rationale:"'zebra'은(는) '얼룩말'을 의미합니다." },
      { word:"grape", meaning:"포도", phonetic:"/ɡreɪp/", question:"grape", hint:"과일", options:["포도","조용한","숙녀","베개"], correct:0, rationale:"'grape'은(는) '포도'를 의미합니다." },
      { word:"pocket", meaning:"주머니", phonetic:"/ˈpɒkɪt/", question:"pocket", hint:"옷의 일부", options:["주머니","오징어","숙녀","조용한"], correct:0, rationale:"'pocket'은(는) '주머니'를 의미합니다." },
      { word:"squid", meaning:"오징어", phonetic:"/skwɪd/", question:"squid", hint:"바다동물", options:["오징어","포도","숙녀","주머니"], correct:0, rationale:"'squid'은(는) '오징어'를 의미합니다." },
      { word:"rabbit", meaning:"토끼", phonetic:"/ˈræbɪt/", question:"rabbit", hint:"귀가 긴 동물", options:["베개","토끼","포도","오징어"], correct:1, rationale:"'rabbit'은(는) '토끼'를 의미합니다." },
      { word:"pillow", meaning:"베개", phonetic:"/ˈpɪloʊ/", question:"pillow", hint:"자는 도구", options:["주머니","포도","베개","토끼"], correct:2, rationale:"'pillow'은(는) '베개'를 의미합니다." },
      { word:"quiet", meaning:"조용한", phonetic:"/ˈkwaɪət/", question:"quiet", hint:"소리가 없는 상태", options:["조용한","숙녀","포도","오징어"], correct:0, rationale:"'quiet'은(는) '조용한'을 의미합니다." },
      { word:"lady", meaning:"숙녀", phonetic:"/ˈleɪdi/", question:"lady", hint:"여성", options:["숙녀","토끼","포도","베개"], correct:0, rationale:"'lady'은(는) '숙녀'를 의미합니다." }
    ];
    const sampleQuizData4 = [
      { word:"clothes", meaning:"옷", phonetic:"/kloʊðz/", question:"clothes", hint:"입는 것", options:["옷","자세","배고픈","산"], correct:0, rationale:"'clothes'은(는) '옷'을 의미합니다." },
      { word:"gesture", meaning:"자세", phonetic:"/ˈdʒɛstʃər/", question:"gesture", hint:"몸짓", options:["자세","국가","박물관","소풍"], correct:0, rationale:"'gesture'은(는) '자세'를 의미합니다." },
      { word:"giant", meaning:"큰", phonetic:"/ˈdʒaɪənt/", question:"giant", hint:"크기", options:["옷","큰","국가","산"], correct:1, rationale:"'giant'은(는) '큰'을 의미합니다." },
      { word:"nation", meaning:"국가", phonetic:"/ˈneɪʃən/", question:"nation", hint:"나라", options:["옷","국가","소풍","산"], correct:1, rationale:"'nation'은(는) '국가'를 의미합니다." },
      { word:"hungry", meaning:"배고픈", phonetic:"/ˈhʌŋɡri/", question:"hungry", hint:"식사 전 상태", options:["옷","배고픈","자세","국가"], correct:1, rationale:"'hungry'은(는) '배고픈'을 의미합니다." },
      { word:"mountain", meaning:"산", phonetic:"/ˈmaʊntən/", question:"mountain", hint:"자연", options:["박물관","산","소풍","옷"], correct:1, rationale:"'mountain'은(는) '산'을 의미합니다." },
      { word:"museum", meaning:"박물관", phonetic:"/mjuˈziːəm/", question:"museum", hint:"전시", options:["박물관","소풍","옷","국가"], correct:0, rationale:"'museum'은(는) '박물관'을 의미합니다." },
      { word:"picnic", meaning:"소풍", phonetic:"/ˈpɪknɪk/", question:"picnic", hint:"야외 활동", options:["소풍","산","박물관","국가"], correct:0, rationale:"'picnic'은(는) '소풍'을 의미합니다." }
    ];
    const sampleQuizData5 = [
      { word:"restroom", meaning:"공중화장실", phonetic:"/ˈrɛstruːm/", question:"restroom", hint:"공공장소", options:["공중화장실","회사","비행기","국가"], correct:0, rationale:"'restroom'은(는) '공중화장실'을 의미합니다." },
      { word:"danger", meaning:"위험", phonetic:"/ˈdeɪndʒər/", question:"danger", hint:"안전의 반대", options:["위험","아름다운","대부분","호기심"], correct:0, rationale:"'danger'은(는) '위험'을 의미합니다." },
      { word:"beautiful", meaning:"아름다운", phonetic:"/ˈbjuːtɪfəl/", question:"beautiful", hint:"예쁜", options:["대부분","아름다운","비행기","회사"], correct:1, rationale:"'beautiful'은(는) '아름다운'을 의미합니다." },
      { word:"almost", meaning:"대부분", phonetic:"/ˈɔːlmoʊst/", question:"almost", hint:"거의", options:["아름다운","대부분","호기심","회사"], correct:1, rationale:"'almost'은(는) '대부분'을 의미합니다." },
      { word:"airplane", meaning:"비행기", phonetic:"/ˈɛrpleɪn/", question:"airplane", hint:"하늘", options:["비행기","회사","위험","공중화장실"], correct:0, rationale:"'airplane'은(는) '비행기'를 의미합니다." },
      { word:"curious", meaning:"호기심이 많은", phonetic:"/ˈkjʊriəs/", question:"curious", hint:"알고 싶어함", options:["호기심이 많은","비행기","회사","대부분"], correct:0, rationale:"'curious'은(는) '호기심이 많은'을 의미합니다." },
      { word:"company", meaning:"회사", phonetic:"/ˈkʌmpəni/", question:"company", hint:"직장", options:["회사","비행기","위험","공중화장실"], correct:0, rationale:"'company'은(는) '회사를 의미합니다." },
      { word:"history", meaning:"역사", phonetic:"/ˈhɪstəri/", question:"history", hint:"과거", options:["역사","회사","호기심이 많은","공중화장실"], correct:0, rationale:"'history'은(는) '역사'를 의미합니다." }
    ];

    /* 기본 세트(전역 안전 보관) */
    window.BUILTIN_QUIZ_SETS = [
      { key:-1, name:"기본단어1", data:sampleQuizData1 },
      { key:-2, name:"기본단어2", data:sampleQuizData2 },
      { key:-3, name:"기본단어3", data:sampleQuizData3 },
      { key:-4, name:"기본단어4", data:sampleQuizData4 },
      { key:-5, name:"기본단어5", data:sampleQuizData5 }
    ];

    /* ========================= 2) DOM ========================= */
    // [수정됨] 스크립트가 DOM보다 늦게 로드되므로, 모든 DOM 요소는 이 시점에서 사용 가능
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const startRandomQuizBtn = document.getElementById('start-random-quiz-btn');
    const quizContainer = document.getElementById('quiz-container');
    const quizTitleEl = document.getElementById('quiz-title');
    const progressEl = document.getElementById('progress');
    const quizContentEl = document.getElementById('quiz-content');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const rationaleEl = document.getElementById('rationale');
    const homeBtn = document.getElementById('home-btn');
    const quitBtn = document.getElementById('quit-btn');
    const quizPrevArrow = document.getElementById('quiz-prev-arrow');
    const quizNextArrow = document.getElementById('quiz-next-arrow');
    const resultEl = document.getElementById('result');
    const scoreDisplayEl = document.getElementById('score-display');
    const wrongAnswersListDiv = document.getElementById('wrong-answers-list');
    const retryBtn = document.getElementById('retry-btn');
    const backToMainBtn = document.getElementById('back-to-main-btn');

    const startLearnBtn = document.getElementById('start-learn-btn');
    const flashcardContainer = document.getElementById('flashcard-container');
    const flashcardScene = document.getElementById('flashcard-scene');
    const flashcard = document.getElementById('flashcard');
    const flashcardTitle = document.getElementById('flashcard-title');
    const flashcardFront = document.getElementById('flashcard-front');
    const flashcardBack = document.getElementById('flashcard-back');
    const flashcardProgress = document.getElementById('flashcard-progress');
    const exitStudyBtn = document.getElementById('exit-study-btn');
    const studyCompleteContainer = document.getElementById('study-complete-container');
    const studySummaryList = document.getElementById('study-summary-list');
    const startQuizFromSummaryBtn = document.getElementById('start-quiz-from-summary-btn');
    
    // [수정됨] HTML에서 ID 중복을 해결하면서, 요약 화면의 '메인으로' 버튼 ID가 변경됨
    // study-complete-container 내부의 main-from-summary-btn을 사용해야 함
    const mainFromSummaryBtn = document.querySelector('#study-complete-container #main-from-summary-btn'); 
    
    const cardPrevArrow = document.getElementById('card-prev-arrow');
    const cardNextArrow = document.getElementById('card-next-arrow');

    const quizList = document.getElementById('quiz-list');
    const noQuizList = document.getElementById('no-quiz-list');
    const selectionMessage = document.getElementById('selection-message');

    const accordionHeaderNewQuiz = document.getElementById('accordion-header-new-quiz');
    const accordionContentNewQuiz = document.getElementById('accordion-content-new-quiz');
    const newQuizNameInput = document.getElementById('new-quiz-name');
    const tempWordListDiv = document.getElementById('temp-word-list');
    const tempWordCountSpan = document.getElementById('temp-word-count');
    const saveNewQuizBtn = document.getElementById('save-new-quiz-btn');
    const manualAddMessage = document.getElementById('manual-add-message');

    const ocrImageInput = document.getElementById('ocr-image-input');
    const ocrExtractBtn = document.getElementById('ocr-extract-btn');
    const ocrMessage = document.getElementById('ocr-message');
    const newWordAutoInput = document.getElementById('new-word-auto');
    const addWordAutoBtn = document.getElementById('add-word-auto-btn');
    const autoAddLoader = document.getElementById('auto-add-loader');
    const autoAddMessage = document.getElementById('auto-add-message');

    const newWordManualInput = document.getElementById('new-word-manual');
    const newMeaningManualInput = document.getElementById('new-meaning-manual');
    const newPhoneticManualInput = document.getElementById('new-phonetic-manual');
    const addWordManualBtn = document.getElementById('add-word-manual-btn');

    const playerNameInput = document.getElementById('player-name');
    const rankingList = document.getElementById('ranking-list');
    const noRankingList = document.getElementById('no-ranking-list');
    const rankingResetBtn = document.getElementById('ranking-reset-btn');

    const accordionHeaderOndap = document.getElementById('accordion-header-ondap');
    const accordionContentOndap = document.getElementById('accordion-content-ondap');
    const startWrongQuizBtn = document.getElementById('start-wrong-quiz-btn');
    const wrongQuizMessage = document.getElementById('wrong-quiz-message');

    const accordionHeaderHistory = document.getElementById('accordion-header-history');
    const accordionContentHistory = document.getElementById('accordion-content-history');
    const historyList = document.getElementById('history-list');
    const noHistoryList = document.getElementById('no-history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');

    const editModalBackdrop = document.getElementById('edit-modal-backdrop');
    const editModal = document.getElementById('edit-modal');
    const editModalCloseBtn = document.getElementById('edit-modal-close-btn');
    const editModalTitle = document.getElementById('edit-modal-title');
    const editQuizNameInput = document.getElementById('edit-quiz-name');
    const editWordListDiv = document.getElementById('edit-word-list');
    const editWordCountSpan = document.getElementById('edit-word-count');
    const editNewWordInput = document.getElementById('edit-new-word');
    const editNewMeaningInput = document.getElementById('edit-new-meaning');
    const editNewPhoneticInput = document.getElementById('edit-new-phonetic');
    const editAddWordBtn = document.getElementById('edit-add-word-btn');
    const editManualAddMessage = document.getElementById('edit-manual-add-message');
    const editModalSaveBtn = document.getElementById('edit-modal-save-btn');
    const editModalCancelBtn = document.getElementById('edit-modal-cancel-btn');

    /* ========================= 3) 상태/스토리지 ========================= */
    let activeQuizData = [];
    let currentQuestionIndex = 0;
    let wrongAnswers = [];
    let activeStudyData = [];
    let currentCardIndex = 0;
    let autoFlipTimer;
    let touchStartX = 0, touchEndX = 0;

    let savedWordLists = [];
    const STORAGE_KEY = 'englishQuizLists_v8';
    let tempWords = [];

    let currentPlayerName = '';
    const PLAYER_KEY = 'englishQuizPlayer_v8';
    let rankings = {};
    const RANKING_KEY = 'englishQuizRankings_v8';
    let wrongAnswerBank = [];
    const WRONG_ANSWERS_KEY = 'englishQuizWrongAnswers_v8';
    let quizHistory = [];
    const HISTORY_KEY = 'englishQuizHistory_v8';

    let editingQuizIndex = -1;
    let editingTempWords = [];

    /* ========================= 4) 유틸 ========================= */
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    function getBuiltinQuizSets(){
      const g = (Array.isArray(window.BUILTIN_QUIZ_SETS) ? window.BUILTIN_QUIZ_SETS : []);
      return g.length ? g : [
        { key:-1, name:"기본단어1", data:sampleQuizData1 },
        { key:-2, name:"기본단어2", data:sampleQuizData2 },
        { key:-3, name:"기본단어3", data:sampleQuizData3 },
        { key:-4, name:"기본단어4", data:sampleQuizData4 },
        { key:-5, name:"기본단어5", data:sampleQuizData5 }
      ];
    }
    function getAllBuiltinQuestions(){ return getBuiltinQuizSets().flatMap(s=>s.data||[]); }

    /* ========================= 5) 렌더(목록) ========================= */
    function loadWordLists(){ savedWordLists = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    function saveWordLists(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(savedWordLists)); }
    function formatCreationDate(ts){ if(!ts) return ''; const d=new Date(ts); return `생성일: ${d.getFullYear()}. ${d.getMonth()+1}. ${d.getDate()}.`; }

    function renderWordList() {
      // 리스트 영역 초기화
      quizList.innerHTML = '';

      // 1) 기본 세트(내장) 불러오기
      const builtinSets = getBuiltinQuizSets(); // 유틸 함수 사용

      // 2) 기본 세트 렌더링
      builtinSets.forEach((set, idx) => {
        const item = document.createElement('div');
        // [수정됨] CSS 스타일(.btn-secondary, .btn-danger)에 맞게 클래스 변경
        item.className = 'flex items-center p-3 bg-white border rounded-lg';
        item.innerHTML = `
          <input type="checkbox" class="quiz-select-cb" id="quiz-cb-builtin-${idx}" data-index="${set.key}">
          <label for="quiz-cb-builtin-${idx}" class="quiz-item-label">
            <span>${set.name} (${set.data.length}문제)</span>
          </label>
          <div class="quiz-item-buttons">
            <button class="btn btn-xs btn-secondary" disabled title="기본 단어장은 편집할 수 없습니다.">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <button class="btn btn-xs btn-danger" disabled title="기본 단어장은 삭제할 수 없습니다.">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        quizList.appendChild(item);
      });

      // 3) 사용자 저장 단어장 렌더링
      if (savedWordLists.length > 0) {
        savedWordLists.forEach((quiz, index) => {
          const it = document.createElement('div');
          it.className = 'flex items-center p-3 bg-white border rounded-lg';
          const creationDate = formatCreationDate(quiz.creationDate);
          it.innerHTML = `
            <input type="checkbox" class="quiz-select-cb" id="quiz-cb-${index}" data-index="${index}">
            <label for="quiz-cb-${index}" class="quiz-item-label">
              <span>${quiz.name} (${quiz.questions.length}문제)</span>
              ${creationDate ? `<div class="quiz-item-date">${creationDate}</div>` : ''}
            </label>
            <div class="quiz-item-buttons">
              <button class="btn btn-xs btn-secondary edit-quiz-btn" data-index="${index}" title="단어장 편집">
                <i class="fas fa-pencil-alt"></i>
              </button>
              <button class="btn btn-xs btn-danger delete-quiz-btn" data-index="${index}" title="단어장 삭제">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          `;
          quizList.appendChild(it);
        });
      }

      // 4) “저장된 단어장이 없습니다” 표시 토글
      const hasAny = builtinSets.length > 0 || (savedWordLists && savedWordLists.length > 0);
      if (hasAny) noQuizList.classList.add('hidden');
      else noQuizList.classList.remove('hidden');

      startLearnBtn.disabled = startQuizBtn.disabled = startRandomQuizBtn.disabled = true;
      selectionMessage.textContent = '';
    }

    /* ========================= 6) 퀴즈 ========================= */
    function startQuiz(quizData, title="단어 퀴즈"){
      if(!quizData.length){
        selectionMessage.textContent='퀴즈를 시작하려면 단어를 1개 이상 선택하세요.';
        selectionMessage.className='muted';
        return;
      }
      activeQuizData = quizData.map(q=>({...q,answered:false,selected:-1}));
      shuffleArray(activeQuizData);
      currentQuestionIndex=0; wrongAnswers=[];

      quizTitleEl.textContent=title;
      quizContainer.classList.remove('hidden');
      resultEl.classList.add('hidden');
      quizContentEl.style.display='block';
      wrongAnswersListDiv.innerHTML='';
      loadQuestion();
    }
    function loadQuestion(){
      resetQuestionUI();
      const cur = activeQuizData[currentQuestionIndex];
      progressEl.textContent = `문제 ${currentQuestionIndex+1} / ${activeQuizData.length}`;
      questionEl.textContent = cur.question;

      quizPrevArrow.disabled = (currentQuestionIndex===0);
      // [수정됨] 마지막 문제에서도 다음 버튼 비활성화 (결과보기는 다음 로직에서)
      quizNextArrow.disabled = (currentQuestionIndex === activeQuizData.length - 1) && cur.answered;


      cur.options.forEach((opt, i) => {
        const b = document.createElement('button');
        // [수정됨] CSS 스타일 적용을 위해 .btn, .btn-secondary 클래스 제거
        b.className = 'option-btn'; 
        b.textContent = opt;
        b.dataset.index = i;
        b.addEventListener('click', selectAnswer);
        optionsEl.appendChild(b);

        if (cur.answered){
          // [수정됨] 정답/오답 시 클래스 변경
          if (i===cur.correct) {
            b.classList.remove('btn-secondary');
            b.classList.add('correct');
          } else if (i===cur.selected) {
            b.classList.remove('btn-secondary');
            b.classList.add('wrong');
          }
          b.disabled = true;
        }
      });

      if (cur.answered){
        if (cur.rationale){ rationaleEl.textContent = cur.rationale; rationaleEl.style.display='block'; }
        quizNextArrow.disabled = false; // 답변을 하면 다음 버튼 활성화
        if(currentQuestionIndex === activeQuizData.length - 1) {
          quizNextArrow.textContent = '결과 보기 →'; // 마지막 문제일 경우 텍스트 변경
        } else {
          quizNextArrow.textContent = '다음 →';
        }
      } else {
        quizPrevArrow.disabled = true;
        quizNextArrow.disabled = true; // 답변 전에는 다음 버튼 비활성화
      }
    }
    function resetQuestionUI(){
      optionsEl.innerHTML=''; rationaleEl.textContent=''; rationaleEl.style.display='none';
      quizPrevArrow.disabled=true; quizNextArrow.disabled=true;
      quizNextArrow.textContent = '다음 →'; // 버튼 텍스트 초기화
    }
    function selectAnswer(e){
      const idx = Number(e.target.dataset.index);
      const cur = activeQuizData[currentQuestionIndex];
      if (cur.answered) return;
      cur.answered = true; cur.selected = idx;

      if (idx === cur.correct){
        e.target.classList.add('correct');
        removeWrongAnswer(cur);
      } else {
        e.target.classList.add('wrong');
        addWrongAnswer(cur);
      }

      [...optionsEl.children].forEach(btn=>{
        const i = Number(btn.dataset.index);
        if (i===cur.correct) {
          btn.classList.add('correct');
        }
        btn.disabled = true;
      });

      if (cur.rationale){ rationaleEl.textContent = cur.rationale; rationaleEl.style.display='block'; }
      quizPrevArrow.disabled = (currentQuestionIndex===0);
      quizNextArrow.disabled = false; // 다음 버튼 활성화

      if(currentQuestionIndex === activeQuizData.length - 1) {
        quizNextArrow.textContent = '결과 보기 →'; // 마지막 문제일 경우 텍스트 변경
      }
    }
    function handleNext(){ currentQuestionIndex++; (currentQuestionIndex<activeQuizData.length) ? loadQuestion() : showResults(false); }
    function handlePrev(){ if(currentQuestionIndex>0){ currentQuestionIndex--; loadQuestion(); } }
    function showResults(isQuit=false){
      quizContentEl.style.display='none';
      resultEl.classList.remove('hidden');

      const answered = activeQuizData.filter(q=>q.answered);
      let total, correct, wrong;
      if (isQuit){
        total = answered.length;
        correct = answered.filter(q=>q.selected===q.correct).length;
        wrong = total - correct;
        wrongAnswers = answered.filter(q=>q.selected!==q.correct);
        scoreDisplayEl.textContent = `푼 문제 ${total}개 중 ${correct}개를 맞추셨습니다!`;
      } else {
        total = activeQuizData.length;
        correct = activeQuizData.filter(q=>q.selected===q.correct).length;
        wrong = total - correct;
        wrongAnswers = activeQuizData.filter(q=>q.answered && q.selected!==q.correct);
        scoreDisplayEl.textContent = `총 ${total}문제 중 ${correct}개를 맞추셨습니다!`;
      }

      if (total>0) {
        addHistoryEntry({
          timestamp:Date.now(),
          playerName: currentPlayerName,
          quizName: quizTitleEl.textContent,
          total, correct, wrong
        });
        updateRankings(currentPlayerName, correct);
      }

      wrongAnswersListDiv.innerHTML='';
      if (wrongAnswers.length){
        const h3=document.createElement('h3'); h3.textContent='틀린 문제 목록'; wrongAnswersListDiv.appendChild(h3);
        const ul=document.createElement('ul');
        wrongAnswers.forEach(q=>{ const li=document.createElement('li'); li.innerHTML=`<strong>${q.word}</strong>: ${q.meaning}`; ul.appendChild(li); });
        wrongAnswersListDiv.appendChild(ul);
      } else {
        const p=document.createElement('p'); p.className='muted'; p.textContent = (isQuit && total===0) ? '푼 문제가 없습니다.' : '모든 문제를 맞추셨습니다! 🎉';
        wrongAnswersListDiv.appendChild(p);
      }
    }

    /* ========================= 7) 플래시카드 ========================= */
    function startStudy(data, title="단어 학습"){
      if(!data.length){
        selectionMessage.textContent='학습을 시작하려면 단어를 1개 이상 선택하세요.';
        selectionMessage.className='muted'; return;
      }
      activeStudyData = data.map(q=>({...q}));
      shuffleArray(activeStudyData);
      currentCardIndex=0;

      flashcardTitle.textContent = title;
      flashcardContainer.classList.remove('hidden');
      studyCompleteContainer.classList.add('hidden');
      loadCard(currentCardIndex);
    }
    function loadCard(i){
      if (autoFlipTimer) clearTimeout(autoFlipTimer);
      const c = activeStudyData[i];
      flashcardFront.innerHTML = `<div class="text-4xl" style="font-size: 2.25rem;">${c.word}</div><div class="muted">${c.phonetic||'&nbsp;'}</div>`;
      flashcardBack.innerHTML = `<div class="text-4xl" style="font-size: 2.25rem;">${c.meaning}</div><div class="muted">${c.hint||''}</div>`;
      flashcard.classList.remove('is-flipped');
      flashcardProgress.textContent = `카드 ${i+1} / ${activeStudyData.length}`;
      cardPrevArrow.disabled = (i===0);
      cardNextArrow.disabled = (i===activeStudyData.length-1);
      autoFlipTimer = setTimeout(()=>flashcard.classList.toggle('is-flipped'), 3000);
    }
    function showNextCard(){ (currentCardIndex<activeStudyData.length-1)?(currentCardIndex++,loadCard(currentCardIndex)):showStudySummary(); }
    function showPrevCard(){ if(currentCardIndex>0){ currentCardIndex--; loadCard(currentCardIndex); } }
    function showStudySummary(){
      flashcardContainer.classList.add('hidden');
      studyCompleteContainer.classList.remove('hidden'); // 요약 오버레이 보이기
      studySummaryList.innerHTML='';
      activeStudyData.forEach(c=>{ const li=document.createElement('li'); li.textContent=`${c.word}: ${c.meaning}`; studySummaryList.appendChild(li); });
    }

    /* ========================= 8) 새 단어장/편집 ========================= */
    function renderTempWordList(words=tempWords, listEl=tempWordListDiv, countEl=tempWordCountSpan){
      listEl.innerHTML='';
      if (!words.length) listEl.innerHTML='<div class="muted" style="padding: 10px 0;">단어를 추가해주세요...</div>';
      words.forEach((w,i)=>{
        const d=document.createElement('div');
        d.innerHTML = `<span><strong>${w.word}</strong>: ${w.meaning} ${w.phonetic?`(${w.phonetic})`:''}</span>
          <button class="icon-btn delete-temp-word-btn" data-index="${i}" aria-label="삭제"><i class="fa-solid fa-xmark"></i></button>`;
        listEl.appendChild(d);
      });
      countEl.textContent = words.length;
    }
    function generateQuizFromWords(words){
      const allMeanings = words.map(w=>w.meaning); const qs=[];
      words.forEach(w=>{
        let distract = allMeanings.filter(m=>m!==w.meaning); shuffleArray(distract); distract = distract.slice(0,3);
        const base=["컴퓨터","연필","학교","물병","사랑","시간","하늘"]; let k=0;
        while(distract.length<3){ const cand=base[k++%base.length]; if(cand!==w.meaning && !distract.includes(cand)) distract.push(cand); }
        let options=[...distract,w.meaning]; shuffleArray(options);
        qs.push({ word:w.word,meaning:w.meaning,hint:w.hint||'',phonetic:w.phonetic||null,
          question:w.word, options, correct:options.indexOf(w.meaning),
          rationale:`'${w.word}' (${w.phonetic||'N/A'})은(는) '${w.meaning}'을(를) 의미합니다.` });
      }); return qs;
    }
    function openEditModal(index){
      editingQuizIndex = index; const quiz=savedWordLists[index];
      editingTempWords = quiz.questions.map(q=>({ word:q.word, meaning:q.meaning, phonetic:q.phonetic||null }));
      editModalTitle.textContent = `"${quiz.name}" 단어장 편집`;
      editQuizNameInput.value = quiz.name;
      renderTempWordList(editingTempWords, editWordListDiv, editWordCountSpan);
      editModal.classList.remove('hidden'); editModalBackdrop.classList.remove('hidden');
    }
    function closeEditModal(){
      editingQuizIndex=-1; editingTempWords=[];
      editManualAddMessage.textContent='';
      editNewWordInput.value=''; editNewMeaningInput.value=''; editNewPhoneticInput.value='';
      editModal.classList.add('hidden'); editModalBackdrop.classList.add('hidden');
    }
    function saveEditedQuiz(){
      const newName = (editQuizNameInput.value||'').trim();
      if(!newName){ editManualAddMessage.textContent='단어장 이름을 입력하세요.'; editManualAddMessage.className='muted'; return; }
      if(editingTempWords.length<4){ editManualAddMessage.textContent='퀴즈 생성을 위해 최소 4개의 단어가 필요합니다.'; editManualAddMessage.className='muted'; return; }
      const original = savedWordLists[editingQuizIndex];
      const newQs = generateQuizFromWords(editingTempWords);
      savedWordLists[editingQuizIndex] = { name:newName, questions:newQs, creationDate: original.creationDate };
      saveWordLists(); renderWordList(); closeEditModal();
    }

    /* ========================= 9) 랭킹/오답/기록 ========================= */
    function loadPlayerName(){ currentPlayerName = localStorage.getItem(PLAYER_KEY) || ''; playerNameInput.value = currentPlayerName; }
    function savePlayerName(n){ currentPlayerName=n; localStorage.setItem(PLAYER_KEY,n); }
    function loadRankings(){ rankings = JSON.parse(localStorage.getItem(RANKING_KEY) || '{"startDate":'+Date.now()+',"scores":[]}'); }
    function saveRankings(){ rankings.scores.sort((a,b)=>b.totalScore-a.totalScore); rankings.scores=rankings.scores.slice(0,3); localStorage.setItem(RANKING_KEY, JSON.stringify(rankings)); }
    function resetRankings(){ 
      // [수정됨] window.confirm 대신 confirm 사용 (혹은 커스텀 모달 사용)
      // 여기서는 표준 confirm을 사용합니다.
      const ok = confirm('랭킹 기록을 정말 초기화하시겠습니까?');
      if (ok) {
        rankings={ startDate:Date.now(), scores:[] }; 
        saveRankings(); 
        renderRankings();
      }
    }
    function renderRankings(){
      rankingList.innerHTML=''; const sd=new Date(rankings.startDate);
      const ds=`${sd.getFullYear()}. ${sd.getMonth()+1}. ${sd.getDate()}.`;
      if(!rankings.scores || rankings.scores.length===0){
        noRankingList.classList.remove('hidden');
        noRankingList.innerHTML = `아직 랭킹이 없습니다. <span class="ranking-start-date muted" style="font-size: 13px;">(기록 시작일: ${ds})</span>`;
      }else{
        noRankingList.classList.add('hidden');
        const icons=['<i class="fas fa-crown" style="color: #FFD700;"></i>','<i class="fas fa-crown" style="color: #C0C0C0;"></i>','<i class="fas fa-crown" style="color: #CD7F32;"></i>'];
        rankings.scores.forEach((r,i)=>{ const d=document.createElement('div'); d.className='ranking-item'; d.innerHTML=`<span class="ranking-icon" style="min-width: 24px;">${icons[i]||(i+1)}</span><span class="ranking-name" style="font-weight: 600;">${r.name}</span><span class="ranking-score" style="margin-left: auto; font-weight: 700;">${r.totalScore}점 (누적)</span>`; rankingList.appendChild(d); });
        const p=document.createElement('p'); p.className='ranking-start-date muted'; p.textContent=`(기록 시작일: ${ds})`; p.style.fontSize='13px'; p.style.marginTop='8px';
        rankingList.appendChild(p);
      }
    }
    function updateRankings(name,score){ if(!name||score===0) return; const pts=score*5; const i=(rankings.scores||[]).findIndex(r=>r.name===name); if(i>-1) rankings.scores[i].totalScore+=pts; else { rankings.scores=rankings.scores||[]; rankings.scores.push({name,totalScore:pts}); } saveRankings(); renderRankings(); }

    function loadWrongAnswerBank(){ wrongAnswerBank = JSON.parse(localStorage.getItem(WRONG_ANSWERS_KEY) || '[]'); }
    function saveWrongAnswerBank(){ localStorage.setItem(WRONG_ANSWERS_KEY, JSON.stringify(wrongAnswerBank)); }
    function addWrongAnswer(q){ if(!q.word) return; if(wrongAnswerBank.findIndex(x=>x.word===q.word)===-1){ wrongAnswerBank.push(q); saveWrongAnswerBank(); renderWrongQuizButton(); } }
    function removeWrongAnswer(q){ if(!q.word) return; const i=wrongAnswerBank.findIndex(x=>x.word===q.word); if(i>-1){ wrongAnswerBank.splice(i,1); saveWrongAnswerBank(); renderWrongQuizButton(); } }
    function renderWrongQuizButton(){ const c=wrongAnswerBank.length; if(c>0){ startWrongQuizBtn.disabled=false; startWrongQuizBtn.innerHTML=`<i class="fas fa-redo mr-2"></i> 틀린 문제 (${c}개) 다시 풀기`; wrongQuizMessage.textContent=''; wrongQuizMessage.classList.add('hidden'); } else { startWrongQuizBtn.disabled=true; startWrongQuizBtn.innerHTML=`<i class="fas fa-redo mr-2"></i> 틀린 문제 (0개) 다시 풀기`; wrongQuizMessage.textContent='틀린 문제가 없습니다.'; wrongQuizMessage.className='muted'; wrongQuizMessage.classList.remove('hidden'); } }

    function loadHistory(){ quizHistory = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
    function saveHistory(){ quizHistory = quizHistory.slice(0,1000); localStorage.setItem(HISTORY_KEY, JSON.stringify(quizHistory)); }
    function addHistoryEntry(e){ quizHistory.unshift(e); saveHistory(); renderHistory(); }
    function formatTimestamp(ts){ const d=new Date(ts); const days=['일','월','화','수','목','금','토']; return `${d.getFullYear()}. ${d.getMonth()+1}. ${d.getDate()}.(${days[d.getDay()]}) ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function renderHistory(){
      historyList.innerHTML='';
      if(!quizHistory.length){ noHistoryList.classList.remove('hidden'); noHistoryList.textContent='학습 기록이 없습니다.'; return; }
      noHistoryList.classList.add('hidden');
      quizHistory.forEach(it=>{
        const d=document.createElement('div');
        d.className='history-item';
        d.style.borderBottom = '1px solid #eee';
        d.style.padding = '8px 0';
        const score = it.total>0?Math.round((it.correct/it.total)*100):0;
        const scoreColor = score > 80 ? '#10b981' : (score > 50 ? '#f59e0b' : '#ef4444');
        d.innerHTML = `<span class="timestamp" style="font-size: 13px; color: #6b7280;">${formatTimestamp(it.timestamp)}</span>
          <div class="details" style="font-size: 15px;"><strong>${it.quizName}</strong> (학습자: ${it.playerName||'기록 없음'})<br>
          (${it.total}문제 중 ${it.correct}개 정답, ${it.wrong}개 오답) <span class="score-badge" style="font-weight: 700; color: ${scoreColor};">${score}점</span></div>`;
        historyList.appendChild(d);
      });
    }

    /* ========================= 10) 이벤트 ========================= */
    // 리스트 체크 → 버튼 활성화
    quizList.addEventListener('change', e=>{
      if(!e.target.classList.contains('quiz-select-cb')) return;
      const checked = quizList.querySelectorAll('.quiz-select-cb:checked');
      const on = checked.length>0;
      startLearnBtn.disabled = startQuizBtn.disabled = startRandomQuizBtn.disabled = !on;
      selectionMessage.textContent = on ? `${checked.length}개 단어장 선택됨` : '';
    });
    // 편집/삭제
    quizList.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const index = parseInt(btn.dataset.index, 10);
      if (isNaN(index)) return; // data-index가 없는 버튼(기본단어장) 클릭 방지

      if (btn.classList.contains('delete-quiz-btn')) {
        const ok = confirm('단어장을 삭제하겠습니까?'); // [수정됨] window.confirm
        if (!ok) return;
        savedWordLists.splice(index, 1);
        saveWordLists();
        renderWordList();
        startLearnBtn.disabled = startQuizBtn.disabled = startRandomQuizBtn.disabled = true;
        selectionMessage.textContent = '';
      }

      if (btn.classList.contains('edit-quiz-btn')) {
        openEditModal(index);
      }
    });

    // 학습/퀴즈/랜덤
    startQuizBtn.addEventListener('click', ()=>{
      const {questions, title} = getCombinedQuestions();
      startQuiz(questions, title + " 퀴즈");
    });
    startLearnBtn.addEventListener('click', ()=>{
      const {questions, title} = getCombinedQuestions();
      startStudy(questions, title + " 학습");
    });
    startRandomQuizBtn.addEventListener('click', ()=>{
      const {questions} = getCombinedQuestions();
      if (questions.length<10){ selectionMessage.textContent='랜덤 퀴즈를 위해 10개 이상의 단어를 선택하세요.'; selectionMessage.className='muted'; return; }
      shuffleArray(questions); startQuiz(questions.slice(0,10), '랜덤 퀴즈 (10문제)');
    });

    // 퀴즈 네비
    quizPrevArrow.addEventListener('click', handlePrev);
    quizNextArrow.addEventListener('click', handleNext);
    quitBtn.addEventListener('click', ()=>showResults(true));
    homeBtn.addEventListener('click', ()=>{ quizContainer.classList.add('hidden'); });

    // 퀴즈 스와이프
    quizContentEl.addEventListener('touchstart', e=>{touchStartX=e.changedTouches[0].screenX;},{passive:true});
    quizContentEl.addEventListener('touchend', e=>{touchEndX=e.changedTouches[0].screenX; const th=50; const cur=activeQuizData[currentQuestionIndex]; if(!cur||!cur.answered) return; if(touchEndX<touchStartX-th){ if(!quizNextArrow.disabled) quizNextArrow.click(); } else if(touchEndX>touchStartX+th){ if(!quizPrevArrow.disabled) quizPrevArrow.click(); }});

    // 결과/재시작
    retryBtn.addEventListener('click', ()=>{
      const builtinAll = getAllBuiltinQuestions(); const orig=[];
      activeQuizData.forEach(aq=>{
        let f=builtinAll.find(sq=>sq.word===aq.word);
        if(f){ orig.push(f); return; }
        for(const l of savedWordLists){ const m=l.questions.find(q=>q.word===aq.word); if(m){ orig.push(m); return; } }
      });
      startQuiz(orig.length?orig:activeQuizData, quizTitleEl.textContent);
    });
    backToMainBtn.addEventListener('click', ()=>{ quizContainer.classList.add('hidden'); });

    // 플래시카드
    flashcardScene.addEventListener('click', ()=>flashcard.classList.toggle('is-flipped'));
    cardPrevArrow.addEventListener('click', (e)=>{e.stopPropagation(); showPrevCard();});
    cardNextArrow.addEventListener('click', (e)=>{e.stopPropagation(); showNextCard();});
    exitStudyBtn.addEventListener('click', showStudySummary);
    startQuizFromSummaryBtn.addEventListener('click', ()=>startQuiz(activeStudyData, flashcardTitle.textContent + " 퀴즈"));
    // [수정됨] mainFromSummaryBtn이 studyCompleteContainer 내부에만 있도록 수정됨
    if(mainFromSummaryBtn) {
      mainFromSummaryBtn.addEventListener('click', ()=>{ studyCompleteContainer.classList.add('hidden'); });
    }

    // 새 단어장 - AI 자동 추가(모형)
    addWordAutoBtn.addEventListener('click', async ()=>{
      const word = newWordAutoInput.value.trim();
      if(!word){ autoAddMessage.textContent='영어 단어를 입력하세요.'; autoAddMessage.className='ai-message muted'; return; }
      if(tempWords.find(w=>w.word.toLowerCase()===word.toLowerCase())){ autoAddMessage.textContent=`'${word}'는(은) 이미 추가된 단어입니다.`; autoAddMessage.className='ai-message muted'; return; }
      
      // [수정됨] 데모 기능이므로 준비 중 알림
      autoAddMessage.textContent = 'AI 자동 추가 기능은 현재 준비 중입니다.';
      autoAddMessage.className = 'ai-message muted';
      return;

      /*
      // 데모: 실제 API 없이 임시로 의미/발음 생성
      const meaning = '(자동) 의미';
      const phonetic = '/auto/';
      tempWords.push({word, meaning, hint:'', phonetic});
      renderTempWordList(tempWords, tempWordListDiv, tempWordCountSpan);
      newWordAutoInput.value='';
      autoAddMessage.textContent=`'${word}' 단어를 추가했습니다.`;
      */
    });
    tempWordListDiv.addEventListener('click', e=>{
      const btn = e.target.closest('.delete-temp-word-btn'); if(!btn) return;
      const i = Number(btn.dataset.index); tempWords.splice(i,1);
      renderTempWordList(tempWords, tempWordListDiv, tempWordCountSpan);
    });
    if (addWordManualBtn){
      addWordManualBtn.addEventListener('click', ()=>{
        const w=(newWordManualInput.value||'').trim();
        const m=(newMeaningManualInput.value||'').trim();
        const p=(newPhoneticManualInput.value||'').trim();
        if(!w||!m){ manualAddMessage.textContent='영어·의미를 모두 입력하세요.'; manualAddMessage.className='muted'; return; }
        if(tempWords.find(t=>t.word.toLowerCase()===w.toLowerCase())){ manualAddMessage.textContent=`'${w}'는(은) 이미 추가된 단어입니다.`; manualAddMessage.className='muted'; return; }
        tempWords.push({word:w,meaning:m,hint:'',phonetic:p||null});
        renderTempWordList(tempWords, tempWordListDiv, tempWordCountSpan);
        newWordManualInput.value=''; newMeaningManualInput.value=''; newPhoneticManualInput.value='';
        manualAddMessage.textContent=`'${w}' 단어가 추가되었습니다.`;
        manualAddMessage.className = 'muted';
      });
    }
    saveNewQuizBtn.addEventListener('click', ()=>{
      const name=(newQuizNameInput.value||'').trim();
      if(!name){ manualAddMessage.textContent='단어장 이름을 입력해주세요.'; manualAddMessage.className='muted'; return; }
      if(tempWords.length<4){ manualAddMessage.textContent='퀴즈 생성을 위해 최소 4개의 단어가 필요합니다.'; manualAddMessage.className='muted'; return; }
      const questions = generateQuizFromWords(tempWords);
      const set = { name, questions, creationDate: Date.now() };
      const exist = savedWordLists.findIndex(q=>q.name===name);
      if (exist>-1){ set.creationDate=savedWordLists[exist].creationDate; savedWordLists[exist]=set; manualAddMessage.textContent=`'${name}' 단어장을 덮어썼습니다.`; }
      else { savedWordLists.push(set); manualAddMessage.textContent=`'${name}' 단어장이 저장되었습니다!`; }
      saveWordLists(); renderWordList(); tempWords=[]; newQuizNameInput.value=''; renderTempWordList(tempWords, tempWordListDiv, tempWordCountSpan);
    });

    // 편집 모달 리스너
    editModalCloseBtn.addEventListener('click', (e)=>{e.preventDefault(); closeEditModal();});
    editModalCancelBtn.addEventListener('click', (e)=>{e.preventDefault(); closeEditModal();});
    editModalSaveBtn.addEventListener('click', (e)=>{e.preventDefault(); saveEditedQuiz();});
    editAddWordBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const w=(editNewWordInput.value||'').trim();
      const m=(editNewMeaningInput.value||'').trim();
      const p=(editNewPhoneticInput.value||'').trim();
      if(!w||!m){ editManualAddMessage.textContent='단어와 의미를 모두 입력해주세요.'; editManualAddMessage.className='muted'; return; }
      if(editingTempWords.find(x=>x.word.toLowerCase()===w.toLowerCase())){ editManualAddMessage.textContent=`'${w}'는(은) 이미 추가된 단어입니다.`; editManualAddMessage.className='muted'; return; }
      editingTempWords.push({word:w,meaning:m,hint:'',phonetic:p||null});
      renderTempWordList(editingTempWords, editWordListDiv, editWordCountSpan);
      editNewWordInput.value=''; editNewMeaningInput.value=''; editNewPhoneticInput.value='';
      editManualAddMessage.textContent=`'${w}' 단어가 추가되었습니다.`;
      editManualAddMessage.className = 'muted';
    });
    editWordListDiv.addEventListener('click', e=>{
      const btn=e.target.closest('.delete-temp-word-btn'); if(!btn) return;
      const idx=Number(btn.dataset.index); editingTempWords.splice(idx,1);
      renderTempWordList(editingTempWords, editWordListDiv, editWordCountSpan);
      editManualAddMessage.textContent='단어가 삭제되었습니다.';
      editManualAddMessage.className = 'muted';
    });

    // 오답/기록/랭킹/아코디언
    startWrongQuizBtn.addEventListener('click', ()=>{
      if(!wrongAnswerBank.length){ wrongQuizMessage.textContent='다시 풀 틀린 문제가 없습니다.'; wrongQuizMessage.className='muted'; return; }
      const qs=[...wrongAnswerBank]; shuffleArray(qs); startQuiz(qs,'틀린 문제 퀴즈');
    });
    clearHistoryBtn.addEventListener('click', ()=>{ 
      const ok = confirm('모든 학습 기록을 삭제하시겠습니까?');
      if (ok) {
        quizHistory=[]; 
        saveHistory(); 
        renderHistory(); 
      }
    });
    playerNameInput.addEventListener('change', e=>savePlayerName(e.target.value));
    rankingResetBtn.addEventListener('click', resetRankings);
    
    // [수정됨] 아코디언 토글 로직
    function toggleAccordion(contentEl, headerEl) {
      const isOpen = contentEl.classList.contains('open');
      if (isOpen) {
        contentEl.classList.remove('open');
        headerEl.classList.remove('open');
        contentEl.style.maxHeight = null;
      } else {
        contentEl.classList.add('open');
        headerEl.classList.add('open');
        // max-height를 CSS에서 0으로 제어하므로, 
        // JS에서는 스크롤 높이를 계산하거나 CSS의 .open 스타일을 신뢰합니다.
        // CSS에서 .open { max-height: 600px; } 등으로 처리하는 것을 전제
      }
    }
    
    accordionHeaderOndap.addEventListener('click', ()=> toggleAccordion(accordionContentOndap, accordionHeaderOndap));
    accordionHeaderNewQuiz.addEventListener('click', ()=> toggleAccordion(accordionContentNewQuiz, accordionHeaderNewQuiz));
    accordionHeaderHistory.addEventListener('click', ()=> toggleAccordion(accordionContentHistory, accordionHeaderHistory));


    /* ========================= 11) 합치기 헬퍼 ========================= */
    function getCombinedQuestions(){
      const checked=quizList.querySelectorAll('.quiz-select-cb:checked');
      const builtinSets=getBuiltinQuizSets();
      let qs=[], names=[];
      checked.forEach(box=>{
        const i=parseInt(box.dataset.index,10);
        if(i<0){ const set=builtinSets.find(s=>s.key===i); if(set){ qs.push(...set.data); names.push(set.name); } }
        else { const q=savedWordLists[i]; if(q){ qs.push(...q.questions); names.push(q.name); } }
      });
      return { questions: qs, title: names.join(' + ') || '단어' };
    }

    /* ========================= 12) 초기화 ========================= */
    // [수정됨] DOMContentLoaded 대신 즉시 실행
    (function init() {
      console.log('Initializing app...');
      try {
        loadWordLists(); 
        loadPlayerName(); 
        loadRankings(); 
        loadWrongAnswerBank(); 
        loadHistory();
        
        renderWordList(); 
        renderRankings(); 
        renderWrongQuizButton(); 
        renderHistory();
        renderTempWordList(tempWords, tempWordListDiv, tempWordCountSpan);
        console.log('App initialized successfully.');
      } catch (error) {
        console.error('Initialization failed:', error);
        // 사용자에게 심각한 오류 알림 (예: localStorage 접근 불가)
        const container = document.querySelector('.container');
        if(container) {
          const errorMsg = document.createElement('div');
          errorMsg.textContent = '앱을 초기화하는 중 오류가 발생했습니다. 브라우저 설정을 확인해주세요. (예: 쿠키/로컬 스토리지 차단)';
          errorMsg.style.color = 'red';
          errorMsg.style.padding = '20px';
          errorMsg.style.border = '2px solid red';
          errorMsg.style.borderRadius = '10px';
          container.prepend(errorMsg);
        }
      }
    })();

    /* === script.js 파일 내용 끝 === */
  </script>
</body>
</html>
